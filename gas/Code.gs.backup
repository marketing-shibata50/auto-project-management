/**
 * Ganttãƒãƒ£ãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 *
 * ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Ganttãƒãƒ£ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™
 */

/**
 * ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã„ãŸã¨ãã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“Š ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ')
    .addItem('ğŸ”„ ã™ã¹ã¦æ›´æ–°', 'menuUpdateAll')
    .addItem('ğŸ“‚ Driveã‹ã‚‰å†èª­ã¿è¾¼ã¿', 'menuReloadFromDrive')
    .addSeparator()
    .addItem('ğŸ“Š ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæ›´æ–°', 'menuUpdateGantt')
    .addItem('ğŸ“‹ å…¨ã‚¿ã‚¹ã‚¯ä¸€è¦§æ›´æ–°', 'menuUpdateAllTasks')
    .addItem('âš ï¸ æœŸæ—¥åˆ‡ã‚Œä¸€è¦§æ›´æ–°', 'menuUpdateOverdue')
    .addToUi();
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ã™ã¹ã¦æ›´æ–°
 */
function menuUpdateAll() {
  const ui = SpreadsheetApp.getUi();
  try {
    menuUpdateGantt();
    menuUpdateAllTasks();
    menuUpdateOverdue();
    ui.alert('âœ… æ›´æ–°å®Œäº†', 'ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', ui.ButtonSet.OK);
  } catch (e) {
    ui.alert('âŒ ã‚¨ãƒ©ãƒ¼', `æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${e.message}`, ui.ButtonSet.OK);
  }
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼: Driveã‹ã‚‰å†èª­ã¿è¾¼ã¿
 * Google Driveã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã§èª­ã¿è¾¼ã¿ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åæ˜ 
 */
function menuReloadFromDrive() {
  const ui = SpreadsheetApp.getUi();

  // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  const response = ui.alert(
    'ğŸ“‚ Driveã‹ã‚‰å†èª­ã¿è¾¼ã¿',
    'Google Driveä¸Šã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åæ˜ ã—ã¾ã™ã€‚\n\nå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ',
    ui.ButtonSet.YES_NO
  );

  if (response !== ui.Button.YES) {
    return;
  }

  try {
    // checkForNewJsonFiles ã‚’æ‰‹å‹•å®Ÿè¡Œ
    checkForNewJsonFiles();

    ui.alert(
      'âœ… èª­ã¿è¾¼ã¿å®Œäº†',
      'JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nè©³ç´°ã¯ãƒ­ã‚°ã§ç¢ºèªã§ãã¾ã™ã€‚',
      ui.ButtonSet.OK
    );
  } catch (e) {
    ui.alert(
      'âŒ ã‚¨ãƒ©ãƒ¼',
      `èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${e.message}`,
      ui.ButtonSet.OK
    );
  }
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
 * ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ãƒ¼ãƒˆãŒã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã®å ´åˆã€ãã®ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
 */
function menuUpdateGantt() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const activeSheet = ss.getActiveSheet();
  const sheetName = activeSheet.getName();

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—
  const projectListSheet = ss.getSheetByName(CONFIG.PROJECT_LIST_SHEET_NAME);
  if (!projectListSheet) {
    throw new Error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
  }

  // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã‹ã©ã†ã‹åˆ¤å®šï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‹ã‚‰ãƒªãƒ³ã‚¯ã‚’ç¢ºèªï¼‰
  const data = projectListSheet.getDataRange().getValues();
  let projectId = null;

  for (let i = 1; i < data.length; i++) {
    const rowProjectId = data[i][0];
    const expectedSheetName = `${rowProjectId}_`;
    if (sheetName.startsWith(expectedSheetName)) {
      projectId = rowProjectId;
      break;
    }
  }

  if (!projectId) {
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ãƒˆãŒã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã§ãªã„å ´åˆã€é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã‹æœ€åˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ›´æ–°
    SpreadsheetApp.getUi().alert('âš ï¸ æ³¨æ„', 'ç¾åœ¨ã®ã‚·ãƒ¼ãƒˆã¯ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', SpreadsheetApp.getUi().ButtonSet.OK);
    return;
  }

  // Driveã‹ã‚‰JSONã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
  const folder = DriveApp.getFolderById(CONFIG.DRIVE_FOLDER_ID);
  const files = folder.getFiles();

  while (files.hasNext()) {
    const file = files.next();
    const fileName = file.getName();

    if (fileName.includes(projectId) && fileName.endsWith('.json')) {
      const content = file.getBlob().getDataAsString();
      const projectData = JSON.parse(content);

      const renderer = new GanttRenderer(activeSheet, projectData);
      renderer.render();
      Logger.log(`âœ“ ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã€Œ${sheetName}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
      return;
    }
  }

  throw new Error(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID ${projectId} ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼: å…¨ã‚¿ã‚¹ã‚¯ä¸€è¦§æ›´æ–°
 */
function menuUpdateAllTasks() {
  const sheetManager = new SheetManager();
  const folder = DriveApp.getFolderById(CONFIG.DRIVE_FOLDER_ID);
  const files = folder.getFiles();

  while (files.hasNext()) {
    const file = files.next();
    const fileName = file.getName();

    if (fileName.endsWith('.json')) {
      const content = file.getBlob().getDataAsString();
      const projectData = JSON.parse(content);
      sheetManager.updateAllTasks(projectData);
    }
  }

  Logger.log('âœ“ å…¨ã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼: æœŸæ—¥åˆ‡ã‚Œä¸€è¦§æ›´æ–°
 */
function menuUpdateOverdue() {
  const sheetManager = new SheetManager();
  sheetManager.updateOverdueTasks();
  Logger.log('âœ“ æœŸæ—¥åˆ‡ã‚Œä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰Ganttãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆ
 *
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
 */
function generateGanttFromData(projectData) {
  Logger.log(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${projectData.project_name}ã€ã®Ganttãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹...`);

  const sheetManager = new SheetManager();

  // 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆGanttã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  Logger.log('Ganttãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆä¸­...');
  const ganttSheet = sheetManager.getOrCreateGanttSheet(
    String(projectData.project_id),
    projectData.project_name
  );

  const renderer = new GanttRenderer(ganttSheet, projectData);
  renderer.render();

  // 2. å…¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°
  Logger.log('å…¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
  sheetManager.updateAllTasks(projectData);

  // 3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°ï¼ˆæœ€å¾Œã«æ›´æ–°ã—ã¦ã‚·ãƒ¼ãƒˆãƒªãƒ³ã‚¯ã‚’å–å¾—ï¼‰
  Logger.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°ä¸­...');
  sheetManager.updateProjectList(projectData);

  Logger.log('âœ“ ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°å®Œäº†');
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰project_idã‚’æŠ½å‡º
 * @param {string} fileName - ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: "192_ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª.json" or "processed_192_ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª.json" or "updated_192_ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª.json"ï¼‰
 * @return {string|null} - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDï¼ˆä¾‹: "192"ï¼‰
 */
function extractProjectId(fileName) {
  // processed_ ã¾ãŸã¯ updated_ ã‚’é™¤å»
  const nameWithoutPrefix = fileName.replace(/^(processed_|updated_)/, '');

  // æœ€åˆã® "_" ã‚ˆã‚Šå‰ã‚’å–å¾—
  const match = nameWithoutPrefix.match(/^(\d+)_/);
  return match ? match[1] : null;
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚·ãƒ¼ãƒˆã«æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹ã‹åˆ¤å®š
 * @param {string} projectId - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
 * @return {boolean} - æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰true
 */
function existsInProjectList(projectId) {
  const sheetManager = new SheetManager();
  const projectListSheet = sheetManager.ss.getSheetByName(CONFIG.PROJECT_LIST_SHEET_NAME);

  if (!projectListSheet) {
    return false;
  }

  const data = projectListSheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(projectId)) {
      return true;
    }
  }

  return false;
}

/**
 * Google Driveãƒ•ã‚©ãƒ«ãƒ€ã‚’ç›£è¦–ã—ã¦æœªå‡¦ç†ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
 *
 * ã“ã®é–¢æ•°ã¯æ™‚é–“ãƒ™ãƒ¼ã‚¹ãƒˆãƒªã‚¬ãƒ¼ï¼ˆ1åˆ†ã”ã¨ï¼‰ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
 *
 * å‡¦ç†ãƒ•ãƒ­ãƒ¼:
 * 1. CONFIG.DRIVE_FOLDER_IDã§æŒ‡å®šã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€å†…ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
 * 2. æœªå‡¦ç†ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆprocessed_/updated_ã§å§‹ã¾ã‚‰ãªã„ï¼‰ã‚’å‡¦ç†
 * 3. æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ processed_/updated_ ä»˜ãã§ã‚‚æ›´æ–°
 * 4. å‡¦ç†å¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´:
 *    - æ–°è¦ä½œæˆ: "processed_XXXX.json"
 *    - æ—¢å­˜æ›´æ–°: "updated_XXXX.json"
 *
 * ãƒˆãƒªã‚¬ãƒ¼è¨­å®šæ–¹æ³•:
 * 1. Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã§ã€Œãƒˆãƒªã‚¬ãƒ¼ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
 * 2. ã€Œãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
 * 3. å®Ÿè¡Œã™ã‚‹é–¢æ•°: checkForNewJsonFiles
 * 4. ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚½ãƒ¼ã‚¹: æ™‚é–“ä¸»å°å‹
 * 5. æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®ãƒˆãƒªã‚¬ãƒ¼ã®ã‚¿ã‚¤ãƒ—: åˆ†ãƒ™ãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒãƒ¼
 * 6. æ™‚é–“ã®é–“éš”: 1åˆ†ãŠã
 */
function checkForNewJsonFiles() {
  try {
    const folderId = CONFIG.DRIVE_FOLDER_ID;
    Logger.log(`[DEBUG] ãƒ•ã‚©ãƒ«ãƒ€ID: ${folderId}`);

    if (!folderId) {
      Logger.log('âš  CONFIG.DRIVE_FOLDER_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      return;
    }

    if (folderId === 'your_folder_id_here') {
      Logger.log('âš  CONFIG.DRIVE_FOLDER_ID ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ã¾ã¾ã§ã™ã€‚å®Ÿéš›ã®ãƒ•ã‚©ãƒ«ãƒ€IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    const folder = DriveApp.getFolderById(folderId);
    Logger.log(`[DEBUG] ãƒ•ã‚©ãƒ«ãƒ€å: ${folder.getName()}`);

    const files = folder.getFiles();  // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

    let fileCount = 0;
    let processedCount = 0;

    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();
      const mimeType = file.getMimeType();
      fileCount++;

      Logger.log(`[DEBUG] ãƒ•ã‚¡ã‚¤ãƒ«${fileCount}: ${fileName}`);
      Logger.log(`[DEBUG]   - MIMEã‚¿ã‚¤ãƒ—: ${mimeType}`);
      Logger.log(`[DEBUG]   - .jsonã§çµ‚ã‚ã‚‹? ${fileName.endsWith('.json')}`);
      Logger.log(`[DEBUG]   - processed/updatedæ¸ˆã¿? ${fileName.startsWith('processed_') || fileName.startsWith('updated_')}`);

      // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ãƒã‚§ãƒƒã‚¯
      if (!fileName.endsWith('.json')) {
        Logger.log(`â­  ã‚¹ã‚­ãƒƒãƒ—ï¼ˆJSONã§ã¯ãªã„ï¼‰: ${fileName}`);
        continue;
      }

      // project_idã‚’æŠ½å‡º
      const projectId = extractProjectId(fileName);
      Logger.log(`[DEBUG]   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID: ${projectId}`);

      // å‡¦ç†æ¡ä»¶:
      // 1. processed_ ã¾ãŸã¯ updated_ ã§å§‹ã¾ã‚‰ãªã„ï¼ˆæ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
      // 2. processed_ ã¾ãŸã¯ updated_ ã§å§‹ã¾ã‚‹ãŒæ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
      const isProcessed = fileName.startsWith('processed_') || fileName.startsWith('updated_');
      const isNewFile = !isProcessed;
      const isExistingProject = projectId && existsInProjectList(projectId);

      if (isNewFile || isExistingProject) {
        // æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‹ã©ã†ã‹ã§åˆ¤å®šï¼ˆã“ã¡ã‚‰ã‚’å„ªå…ˆï¼‰
        if (isExistingProject) {
          Logger.log(`âœ“ æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°ã‚’æ¤œå‡º: ${fileName}`);
        } else {
          Logger.log(`âœ“ æ–°ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º: ${fileName}`);
        }

        try {
          // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
          processJsonFile(file.getId());

          // å‡¦ç†æˆåŠŸå¾Œã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´
          if (isExistingProject) {
            // æ—¢å­˜ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ updated_ ã‚’ä»˜ã‘ã‚‹
            const cleanFileName = fileName.replace(/^(processed_|updated_)/, '');
            const newFileName = 'updated_' + cleanFileName;
            file.setName(newFileName);
            Logger.log(`âœ“ æ›´æ–°å®Œäº†ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´: ${newFileName}`);
          } else {
            // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯ processed_ ã‚’ä»˜ã‘ã‚‹
            const newFileName = 'processed_' + fileName;
            file.setName(newFileName);
            Logger.log(`âœ“ æ–°è¦ä½œæˆå®Œäº†ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´: ${newFileName}`);
          }

          processedCount++;
        } catch (error) {
          Logger.log(`âœ— ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼ (${fileName}): ${error.message}`);
          Logger.log(`âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`);
          // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ«ãƒ¼ãƒ—ã¯ç¶šã‘ã‚‹
        }
      } else {
        Logger.log(`â­  ã‚¹ã‚­ãƒƒãƒ—: ${fileName}`);
      }
    }

    Logger.log(`[DEBUG] æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${fileCount}, å‡¦ç†æ•°: ${processedCount}`);

    if (processedCount > 0) {
      Logger.log(`âœ“ ${processedCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸã€‚`);
    } else {
      Logger.log('æœªå‡¦ç†ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
    }

  } catch (error) {
    Logger.log('âœ— ãƒ•ã‚©ãƒ«ãƒ€ç›£è¦–ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    sendDiscordNotification(
      `Google Driveãƒ•ã‚©ãƒ«ãƒ€ã®ç›£è¦–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
  }
}

/**
 * æ‰‹å‹•ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦å‡¦ç†
 *
 * @param {string} fileId - Google Driveã®ãƒ•ã‚¡ã‚¤ãƒ«ID
 */
function processJsonFile(fileId) {
  try {
    const file = DriveApp.getFileById(fileId);
    const content = file.getBlob().getDataAsString();
    const projectData = JSON.parse(content);

    Logger.log(`JSONãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.getName()}ã€ã‚’å‡¦ç†ä¸­...`);
    generateGanttFromData(projectData);

    sendDiscordNotification(
      `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œ${projectData.project_name}ã€ã®Ganttãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚\n` +
      `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.getName()}\n` +
      `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ: https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}`
    );

  } catch (error) {
    Logger.log('âœ— ã‚¨ãƒ©ãƒ¼: ' + error);
    sendDiscordNotification(
      `JSONãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
    throw error;
  }
}

/**
 * å®Ÿéš›ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”Ÿæˆï¼ˆGoogle Driveã®ãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨ï¼‰
 *
 * ã€è‡ªå‹•å®Ÿè¡Œã€‘
 * - npm run gantt:save ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•çš„ã«processJsonFile()ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
 * - Apps Script APIã‚’ä½¿ç”¨ã—ã¦Node.jsã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã•ã‚Œã¾ã™
 *
 * ã€æ‰‹å‹•å®Ÿè¡Œã€‘
 * 1. Google Driveã«JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
 * 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ ã€Œãƒªãƒ³ã‚¯ã‚’å–å¾—ã€ â†’ ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’ã‚³ãƒ”ãƒ¼
 * 3. ä¸‹è¨˜ã® FILE_ID ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«IDã«æ›¸ãæ›ãˆ
 * 4. ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œ
 *
 * ãƒ•ã‚¡ã‚¤ãƒ«IDã®ä¾‹: "1a2b3c4d5e6f7g8h9i0j" ï¼ˆé•·ã„è‹±æ•°å­—ã®æ–‡å­—åˆ—ï¼‰
 */
function generateGanttFromFile() {
  const FILE_ID = 'your_file_id_here'; // ã“ã“ã«å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å…¥åŠ›

  if (FILE_ID === 'your_file_id_here') {
    Logger.log('âš  FILE_ID ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«IDã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚');
    return;
  }

  processJsonFile(FILE_ID);
}

/**
 * å…¨Ganttã‚·ãƒ¼ãƒˆã‚’ä¸€æ‹¬å†åŒæœŸ
 *
 * - å…¨Ganttã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
 * - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã€å…¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã€æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
 */
function syncAllSheets() {
  try {
    Logger.log('=== å…¨Ganttã‚·ãƒ¼ãƒˆã®ä¸€æ‹¬åŒæœŸã‚’é–‹å§‹ ===');

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    // 1. å…¨Ganttã‚·ãƒ¼ãƒˆã‚’æ¤œå‡º
    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/); // "X_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" ã¾ãŸã¯ "XXXX_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" å½¢å¼
    });

    Logger.log(`âœ“ Ganttã‚·ãƒ¼ãƒˆæ¤œå‡º: ${ganttSheets.length}ä»¶`);

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    // 2. å„Ganttã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã£ã¦æ›´æ–°
    let successCount = 0;
    let errorCount = 0;

    for (const ganttSheet of ganttSheets) {
      try {
        Logger.log(`--- ${ganttSheet.getName()} ã‚’åŒæœŸä¸­ ---`);

        // Ganttã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);

        if (!projectData) {
          Logger.log(`âš  ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå¤±æ•—: ${ganttSheet.getName()}`);
          errorCount++;
          continue;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°
        sheetManager.updateProjectList(projectData);

        // å…¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        sheetManager.updateAllTasks(projectData);

        // Ganttã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰é€²æ—ç‡ã‚’æ›´æ–°
        sheetManager.updateGanttProgressFromStatus(ganttSheet);

        Logger.log(`âœ“ åŒæœŸå®Œäº†: ${ganttSheet.getName()}`);
        successCount++;

        // APIåˆ¶é™ãƒ»ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡å¯¾ç­–ï¼šæ¬¡ã®ã‚·ãƒ¼ãƒˆå‡¦ç†ã¾ã§1ç§’å¾…æ©Ÿ
        Utilities.sleep(1000);

      } catch (error) {
        Logger.log(`âœ— åŒæœŸã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
        errorCount++;
      }
    }

    // 3. æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
    Logger.log('--- æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­ ---');
    try {
      const overdueCount = sheetManager.updateOverdueTasks();
      Logger.log(`âœ“ æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°å®Œäº†: ${overdueCount}ä»¶`);
    } catch (error) {
      Logger.log(`âœ— æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }

    Logger.log('=== åŒæœŸå®Œäº† ===');
    Logger.log(`æˆåŠŸ: ${successCount}ä»¶ / ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`);

  } catch (error) {
    Logger.log('âœ— å…¨ä½“ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    throw error;
  }
}

/**
 * Ganttã‚·ãƒ¼ãƒˆã‚’ãƒãƒƒãƒå‡¦ç†ã§åŒæœŸ
 *
 * @param {number} startIndex - é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ0å§‹ã¾ã‚Šï¼‰
 * @param {number} batchSize - å‡¦ç†ã™ã‚‹ã‚·ãƒ¼ãƒˆæ•°
 * @param {boolean} updateOverdue - æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
 */
function syncBatchSheets(startIndex, batchSize, updateOverdue = false) {
  try {
    Logger.log(`=== Ganttã‚·ãƒ¼ãƒˆã®ãƒãƒƒãƒåŒæœŸã‚’é–‹å§‹ (${startIndex}~${startIndex + batchSize - 1}) ===`);

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    // 1. å…¨Ganttã‚·ãƒ¼ãƒˆã‚’æ¤œå‡º
    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/); // "X_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" ã¾ãŸã¯ "XXXX_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" å½¢å¼
    });

    Logger.log(`âœ“ Ganttã‚·ãƒ¼ãƒˆæ¤œå‡º: ${ganttSheets.length}ä»¶`);

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    // 2. ãƒãƒƒãƒç¯„å›²ã‚’è¨ˆç®—
    const endIndex = Math.min(startIndex + batchSize, ganttSheets.length);
    const batchSheets = ganttSheets.slice(startIndex, endIndex);

    Logger.log(`âœ“ ãƒãƒƒãƒå‡¦ç†å¯¾è±¡: ${batchSheets.length}ä»¶ (${startIndex}~${endIndex - 1})`);

    if (batchSheets.length === 0) {
      Logger.log('âš  å‡¦ç†å¯¾è±¡ã®ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    // 3. å„Ganttã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã£ã¦æ›´æ–°
    let successCount = 0;
    let errorCount = 0;

    for (const ganttSheet of batchSheets) {
      try {
        Logger.log(`--- ${ganttSheet.getName()} ã‚’åŒæœŸä¸­ ---`);

        // Ganttã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);

        if (!projectData) {
          Logger.log(`âš  ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå¤±æ•—: ${ganttSheet.getName()}`);
          errorCount++;
          continue;
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’æ›´æ–°
        sheetManager.updateProjectList(projectData);

        // å…¨ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        sheetManager.updateAllTasks(projectData);

        // Ganttã‚·ãƒ¼ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰é€²æ—ç‡ã‚’æ›´æ–°
        sheetManager.updateGanttProgressFromStatus(ganttSheet);

        Logger.log(`âœ“ åŒæœŸå®Œäº†: ${ganttSheet.getName()}`);
        successCount++;

        // APIåˆ¶é™ãƒ»ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡å¯¾ç­–ï¼šæ¬¡ã®ã‚·ãƒ¼ãƒˆå‡¦ç†ã¾ã§1ç§’å¾…æ©Ÿ
        Utilities.sleep(1000);

      } catch (error) {
        Logger.log(`âœ— åŒæœŸã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
        errorCount++;
      }
    }

    // 4. æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ï¼ˆæœ€å¾Œã®ãƒãƒƒãƒã®ã¿ï¼‰
    if (updateOverdue) {
      Logger.log('--- æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­ ---');
      try {
        const overdueCount = sheetManager.updateOverdueTasks();
        Logger.log(`âœ“ æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°å®Œäº†: ${overdueCount}ä»¶`);
      } catch (error) {
        Logger.log(`âœ— æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    Logger.log('=== ãƒãƒƒãƒåŒæœŸå®Œäº† ===');
    Logger.log(`æˆåŠŸ: ${successCount}ä»¶ / ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`);

  } catch (error) {
    Logger.log('âœ— ãƒãƒƒãƒå…¨ä½“ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    throw error;
  }
}

/**
 * ãƒãƒƒãƒ1: 0-4ç•ªç›®ã®ã‚·ãƒ¼ãƒˆã‚’åŒæœŸ
 */
function syncBatch1() {
  syncBatchSheets(0, 5);
}

/**
 * ãƒãƒƒãƒ2: 5-9ç•ªç›®ã®ã‚·ãƒ¼ãƒˆã‚’åŒæœŸ
 */
function syncBatch2() {
  syncBatchSheets(5, 5);
}

/**
 * ãƒãƒƒãƒ3: 10-14ç•ªç›®ã®ã‚·ãƒ¼ãƒˆã‚’åŒæœŸ
 */
function syncBatch3() {
  syncBatchSheets(10, 5);
}

/**
 * ãƒãƒƒãƒ4: 15-19ç•ªç›®ã®ã‚·ãƒ¼ãƒˆã‚’åŒæœŸ
 */
function syncBatch4() {
  syncBatchSheets(15, 5);
}

/**
 * ãƒãƒƒãƒ5: 20ç•ªç›®ä»¥é™ã®ã‚·ãƒ¼ãƒˆã‚’åŒæœŸ + æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°
 */
function syncBatch5() {
  syncBatchSheets(20, 5, true); // æœ€å¾Œã®ãƒãƒƒãƒã®ã¿æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°
}

/**
 * è‡ªå‹•ç¶™ç¶šæ–¹å¼ã®ãƒãƒƒãƒåŒæœŸ
 * - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã§é€²æ—ã‚’ä¿å­˜
 * - å‰å›ã®ç¶šãã‹ã‚‰5ã‚·ãƒ¼ãƒˆãšã¤å‡¦ç†
 * - å…¨ã‚·ãƒ¼ãƒˆå®Œäº†ã—ãŸã‚‰æœ€åˆã«æˆ»ã‚‹
 * - æœ€å¾Œã®ãƒãƒƒãƒã§æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°
 */
function syncNextBatch() {
  try {
    const scriptProperties = PropertiesService.getScriptProperties();
    const BATCH_SIZE = 5;

    // ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆåˆå›ã¯0ï¼‰
    let currentIndex = parseInt(scriptProperties.getProperty('SYNC_CURRENT_INDEX') || '0');

    Logger.log(`=== è‡ªå‹•ç¶™ç¶šãƒãƒƒãƒåŒæœŸé–‹å§‹ (é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${currentIndex}) ===`);

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    // Ganttã‚·ãƒ¼ãƒˆã‚’æ¤œå‡º
    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/);
    });

    const totalSheets = ganttSheets.length;
    Logger.log(`âœ“ ç·Ganttã‚·ãƒ¼ãƒˆæ•°: ${totalSheets}ä»¶`);

    if (totalSheets === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      scriptProperties.setProperty('SYNC_CURRENT_INDEX', '0');
      return;
    }

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç¯„å›²å¤–ã®å ´åˆã¯ãƒªã‚»ãƒƒãƒˆ
    if (currentIndex >= totalSheets) {
      Logger.log('âœ“ å…¨ã‚·ãƒ¼ãƒˆå‡¦ç†å®Œäº†ã€‚æœ€åˆã«æˆ»ã‚Šã¾ã™ã€‚');
      currentIndex = 0;
    }

    // ãƒãƒƒãƒç¯„å›²ã‚’è¨ˆç®—
    const endIndex = Math.min(currentIndex + BATCH_SIZE, totalSheets);
    const batchSheets = ganttSheets.slice(currentIndex, endIndex);
    const isLastBatch = endIndex >= totalSheets;

    Logger.log(`âœ“ ãƒãƒƒãƒå‡¦ç†: ${batchSheets.length}ä»¶ (${currentIndex}~${endIndex - 1}) ${isLastBatch ? '[æœ€çµ‚ãƒãƒƒãƒ]' : ''}`);

    // å„ã‚·ãƒ¼ãƒˆã‚’åŒæœŸ
    let successCount = 0;
    let errorCount = 0;

    for (const ganttSheet of batchSheets) {
      try {
        Logger.log(`--- ${ganttSheet.getName()} ã‚’åŒæœŸä¸­ ---`);

        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);

        if (!projectData) {
          Logger.log(`âš  ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå¤±æ•—: ${ganttSheet.getName()}`);
          errorCount++;
          continue;
        }

        sheetManager.updateProjectList(projectData);
        sheetManager.updateAllTasks(projectData);
        sheetManager.updateGanttProgressFromStatus(ganttSheet);

        Logger.log(`âœ“ åŒæœŸå®Œäº†: ${ganttSheet.getName()}`);
        successCount++;

        Utilities.sleep(1000);

      } catch (error) {
        Logger.log(`âœ— åŒæœŸã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
        errorCount++;
      }
    }

    // æœ€çµ‚ãƒãƒƒãƒã®å ´åˆã¯æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°
    if (isLastBatch) {
      Logger.log('--- æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­ ---');
      try {
        const overdueCount = sheetManager.updateOverdueTasks();
        Logger.log(`âœ“ æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°å®Œäº†: ${overdueCount}ä»¶`);
      } catch (error) {
        Logger.log(`âœ— æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    // æ¬¡å›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
    const nextIndex = isLastBatch ? 0 : endIndex;
    scriptProperties.setProperty('SYNC_CURRENT_INDEX', nextIndex.toString());

    Logger.log('=== ãƒãƒƒãƒåŒæœŸå®Œäº† ===');
    Logger.log(`æˆåŠŸ: ${successCount}ä»¶ / ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`);
    Logger.log(`æ¬¡å›é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${nextIndex} ${isLastBatch ? '(æœ€åˆã«æˆ»ã‚‹)' : ''}`);

  } catch (error) {
    Logger.log('âœ— ãƒãƒƒãƒå…¨ä½“ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    throw error;
  }
}

/**
 * å…¨Ganttã‚·ãƒ¼ãƒˆã‚’å¼·åˆ¶çš„ã«å†åŒæœŸ
 * ï¼ˆå¤‰æ›´æ¤œçŸ¥æ©Ÿèƒ½ã‚’å‰Šé™¤ã—ãŸãŸã‚ã€syncAllSheets()ã¨åŒã˜ï¼‰
 */
function forceResyncAll() {
  syncAllSheets();
}

/**
 * å…¨Ganttã‚·ãƒ¼ãƒˆã®æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã«è‰²ä»˜ã‘
 * - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã¯ä¸€åˆ‡è§¦ã‚‰ãªã„
 * - çµ‚äº†æ—¥ã‚»ãƒ«ï¼ˆGåˆ—ï¼‰ã®ã¿è‰²ä»˜ã‘ï¼ˆèµ¤èƒŒæ™¯ãƒ»é»„è‰²æ–‡å­—ãƒ»å¤ªå­—ï¼‰
 * - render()ã‚’ä½¿ã‚ãªã„ã®ã§è¶…è»½é‡
 */
function updateOverdueColors() {
  try {
    Logger.log('=== æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã®è‰²ä»˜ã‘é–‹å§‹ ===');

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    // Ganttã‚·ãƒ¼ãƒˆã‚’æ¤œå‡º
    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/);
    });

    Logger.log(`âœ“ Ganttã‚·ãƒ¼ãƒˆæ¤œå‡º: ${ganttSheets.length}ä»¶`);

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let totalColoredCells = 0;

    for (const ganttSheet of ganttSheets) {
      try {
        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®é–‹å§‹è¡Œï¼ˆGanttRendererã®æ§‹é€ : 2è¡Œç›®ãŒãƒ˜ãƒƒãƒ€ãƒ¼ã€4è¡Œç›®ã‹ã‚‰ã‚¿ã‚¹ã‚¯ï¼‰
        const lastRow = ganttSheet.getLastRow();
        if (lastRow < 4) continue;

        const taskStartRow = 4; // å›ºå®šï¼ˆ4è¡Œç›®ã‹ã‚‰ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ï¼‰

        // ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’å–å¾—
        const taskDataRange = ganttSheet.getRange(taskStartRow, 1, lastRow - taskStartRow + 1, 9);
        const taskData = taskDataRange.getValues();

        // å…¨çµ‚äº†æ—¥ã‚»ãƒ«ï¼ˆGåˆ—ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        const endDateCol = ganttSheet.getRange(taskStartRow, 7, taskData.length, 1);
        endDateCol.setBackground('#FFFFFF');
        endDateCol.setFontColor('#000000');
        endDateCol.setFontWeight('normal');

        let coloredCount = 0;

        // å„ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
        for (let i = 0; i < taskData.length; i++) {
          const row = taskData[i];
          const endDateValue = row[6]; // Gåˆ—ï¼ˆçµ‚äº†æ—¥ï¼‰
          const progress = row[7]; // Håˆ—ï¼ˆé€²æ—ç‡ï¼‰

          // ç©ºè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
          if (!row[0]) continue;

          // æœŸæ—¥åˆ‡ã‚Œåˆ¤å®šï¼ˆé€²æ—ç‡ã¯0.0-1.0ã®å°æ•°ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼‰
          if (endDateValue && progress !== 1) {
            const endDate = new Date(endDateValue);
            endDate.setHours(0, 0, 0, 0);

            if (endDate < today) {
              // æœŸæ—¥åˆ‡ã‚Œ â†’ è‰²ä»˜ã‘
              const endDateCell = ganttSheet.getRange(taskStartRow + i, 7);
              endDateCell.setBackground('#FF0000'); // èµ¤èƒŒæ™¯
              endDateCell.setFontColor('#FFFF00'); // é»„è‰²æ–‡å­—
              endDateCell.setFontWeight('bold'); // å¤ªå­—
              coloredCount++;
            }
          }
        }

        if (coloredCount > 0) {
          Logger.log(`âœ“ ${ganttSheet.getName()}: ${coloredCount}ä»¶ã®æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã«è‰²ä»˜ã‘`);
        }
        totalColoredCells += coloredCount;

      } catch (error) {
        Logger.log(`âœ— è‰²ä»˜ã‘ã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
      }
    }

    Logger.log('=== è‰²ä»˜ã‘å®Œäº† ===');
    Logger.log(`ç·è¨ˆ: ${totalColoredCells}ä»¶ã®æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã«è‰²ä»˜ã‘`);

  } catch (error) {
    Logger.log('âœ— å…¨ä½“ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    throw error;
  }
}

/**
 * æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’Discordã«é€šçŸ¥
 *
 * - æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
 * - Discord Webhookã§Embedå½¢å¼ã®é€šçŸ¥ã‚’é€ä¿¡
 */
function sendOverdueTasksNotification() {
  try {
    const sheetManager = new SheetManager();
    const overdueSheet = sheetManager.getOrCreateOverdueTasksSheet();

    // æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã‚’å–å¾—
    const lastRow = overdueSheet.getLastRow();
    if (lastRow <= 1) {
      Logger.log('âœ“ æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼é™¤ãï¼‰
    const data = overdueSheet.getRange(2, 1, lastRow - 1, 9).getValues();

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const projectGroups = {};
    for (const row of data) {
      const projectId = String(row[0] || '');
      const projectName = String(row[1] || '');
      const taskId = String(row[2] || '');
      const parentTaskName = String(row[3] || '');
      const childTaskName = String(row[4] || '');
      const dueDate = row[5] || '';
      const assignee = String(row[6] || '');
      const daysOverdue = row[7] || 0;
      const progress = row[8] || 0;

      // ã‚¿ã‚¹ã‚¯åã‚’æ±ºå®š
      const taskName = childTaskName || parentTaskName || taskId;

      // é€²æ—ç‡ã‚’æ­£è¦åŒ–ï¼ˆ0.0-1.0 â†’ 0-100ï¼‰
      let progressPercent = 0;
      if (typeof progress === 'number') {
        progressPercent = progress <= 1 ? Math.round(progress * 100) : Math.round(progress);
      }

      if (!projectGroups[projectId]) {
        projectGroups[projectId] = {
          projectName: projectName,
          tasks: []
        };
      }

      projectGroups[projectId].tasks.push({
        taskName: taskName,
        dueDate: dueDate,
        assignee: assignee,
        daysOverdue: daysOverdue,
        progress: progressPercent
      });
    }

    // Embedå½¢å¼ã§Discordé€šçŸ¥ã‚’ä½œæˆ
    const embeds = [];

    for (const projectId in projectGroups) {
      const group = projectGroups[projectId];

      // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’Markdownå½¢å¼ã§æ•´å½¢
      const taskList = group.tasks
        .slice(0, 10) // æœ€å¤§10ä»¶ã¾ã§
        .map(task => {
          const dueDateStr = task.dueDate instanceof Date
            ? `${task.dueDate.getMonth() + 1}/${task.dueDate.getDate()}`
            : task.dueDate;
          return `â€¢ **${task.taskName}** (æœŸæ—¥: ${dueDateStr}, é…å»¶: ${task.daysOverdue}æ—¥, é€²æ—: ${task.progress}%)`;
        })
        .join('\n');

      const moreCount = group.tasks.length > 10 ? `\n... ä»–${group.tasks.length - 10}ä»¶` : '';

      embeds.push({
        title: `âš ï¸ æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯: ${group.projectName}`,
        description: taskList + moreCount,
        color: 0xFF6B6B, // èµ¤è‰²
        footer: {
          text: `åˆè¨ˆ ${group.tasks.length}ä»¶ã®æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯`
        }
      });
    }

    if (embeds.length === 0) {
      Logger.log('âœ“ æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
      return;
    }

    // Discord Webhooké€ä¿¡
    const payload = { embeds: embeds };
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, options);
    Logger.log(`âœ“ Discordé€šçŸ¥é€ä¿¡å®Œäº†: ${response.getResponseCode()}`);

  } catch (error) {
    Logger.log(`âœ— Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    Logger.log(`âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`);
    throw error;
  }
}

/**
 * Todoistã®Inboxã‚¿ã‚¹ã‚¯ã‚’åŒæœŸ
 *
 * - Todoist REST API v2ã‚’ä½¿ç”¨ã—ã¦Inboxã‚¿ã‚¹ã‚¯ã‚’å–å¾—
 * - Todoistã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¿
 */
function syncTodoistTasks() {
  try {
    Logger.log('=== Todoistã‚¿ã‚¹ã‚¯åŒæœŸé–‹å§‹ ===');

    // 1. Todoist APIã‹ã‚‰ã‚¿ã‚¹ã‚¯ã‚’å–å¾—
    const apiKey = CONFIG.TODOIST_API_KEY;
    if (!apiKey) {
      Logger.log('âš  TODOIST_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      return 0;
    }

    const url = 'https://api.todoist.com/rest/v2/tasks';
    const options = {
      method: 'get',
      headers: {
        'Authorization': `Bearer ${apiKey}`
      },
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(url, options);
    const responseCode = response.getResponseCode();

    if (responseCode !== 200) {
      Logger.log(`âœ— Todoist API ã‚¨ãƒ©ãƒ¼: ${responseCode}`);
      Logger.log(`âœ— ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.getContentText()}`);
      return 0;
    }

    const allTasks = JSON.parse(response.getContentText());
    Logger.log(`âœ“ Todoistã‚¿ã‚¹ã‚¯å–å¾—å®Œäº†: ${allTasks.length}ä»¶`);

    // 2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—ã—ã¦Inboxãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’ç‰¹å®š
    const projectsUrl = 'https://api.todoist.com/rest/v2/projects';
    const projectsResponse = UrlFetchApp.fetch(projectsUrl, options);
    const projects = JSON.parse(projectsResponse.getContentText());

    let inboxProjectId = null;
    for (const project of projects) {
      if (project.name === 'Inbox' || project.is_inbox_project) {
        inboxProjectId = String(project.id);
        Logger.log(`âœ“ Inboxãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º: ${inboxProjectId}`);
        break;
      }
    }

    if (!inboxProjectId) {
      Logger.log('âš  Inboxãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return 0;
    }

    // 3. Inboxãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const inboxTasks = allTasks.filter(task => String(task.project_id) === inboxProjectId);
    Logger.log(`âœ“ Inboxã‚¿ã‚¹ã‚¯æŠ½å‡ºå®Œäº†: ${inboxTasks.length}ä»¶`);

    // 4. ã‚·ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚¹ã‚¯ã‚’æ›´æ–°
    const sheetManager = new SheetManager();
    const count = sheetManager.updateTodoistTasks(inboxTasks);

    Logger.log(`âœ“ Todoistã‚¿ã‚¹ã‚¯åŒæœŸå®Œäº†: ${count}ä»¶`);
    return count;

  } catch (error) {
    Logger.log(`âœ— Todoistã‚¿ã‚¹ã‚¯åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`);
    Logger.log(`âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`);
    throw error;
  }
}

/**
 * Todoisté€£æºæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆï¼ˆé–‹ç™ºç”¨ï¼‰
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. GASã‚¨ãƒ‡ã‚£ã‚¿ã§ã“ã®é–¢æ•°ã‚’é¸æŠ
 * 2. å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
 * 3. ä»¥ä¸‹ãŒãƒ†ã‚¹ãƒˆã•ã‚Œã¾ã™:
 *    - Todoist APIã‹ã‚‰Inboxã‚¿ã‚¹ã‚¯ã‚’å–å¾—
 *    - Todoistã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿
 *    - Discordé€šçŸ¥ã®é€ä¿¡
 */
/**
 * æ—¢å­˜ã‚·ãƒ¼ãƒˆã«å®Ÿç¸¾å·¥æ•°åˆ—ã‚’è¿½åŠ ã™ã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
 *
 * ã€é‡è¦ã€‘ã“ã®é–¢æ•°ã¯ä¸€åº¦ã ã‘å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
 *
 * å‡¦ç†å†…å®¹:
 * 1. å…¨Ganttã‚·ãƒ¼ãƒˆï¼ˆX_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå½¢å¼ï¼‰ã®12åˆ—ç›®ï¼ˆLåˆ—ï¼‰ã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€åˆ—ã‚’æŒ¿å…¥
 * 2. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã®14åˆ—ç›®ï¼ˆNåˆ—ï¼‰ã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€åˆ—ã‚’æŒ¿å…¥
 *
 * ä½¿ç”¨æ–¹æ³•:
 * 1. GASã‚¨ãƒ‡ã‚£ã‚¿ã§ã“ã®é–¢æ•°ã‚’é¸æŠ
 * 2. å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
 * 3. å®Ÿè¡Œå¾Œã€å„ã‚·ãƒ¼ãƒˆã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€åˆ—ãŒè¿½åŠ ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
 */
function migrateExistingSheetsForActualHours() {
  try {
    Logger.log('=== å®Ÿç¸¾å·¥æ•°åˆ—ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ===');

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    let ganttCount = 0;
    let errorCount = 0;

    // 1. å…¨Ganttã‚·ãƒ¼ãƒˆã‚’å‡¦ç†
    Logger.log('--- Ganttã‚·ãƒ¼ãƒˆã‚’å‡¦ç†ä¸­ ---');

    for (const sheet of allSheets) {
      const sheetName = sheet.getName();

      // Ganttã‚·ãƒ¼ãƒˆï¼ˆX_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå ã¾ãŸã¯ XXXX_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåå½¢å¼ï¼‰ã‚’æ¤œå‡º
      if (sheetName.match(/^\d{1,4}_.+$/)) {
        try {
          Logger.log(`å‡¦ç†ä¸­: ${sheetName}`);

          // 2è¡Œç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‰ã®12åˆ—ç›®ï¼ˆLåˆ—ï¼‰ã®å€¤ã‚’ç¢ºèª
          const currentHeader = sheet.getRange(2, 12).getValue();

          // ã™ã§ã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if (currentHeader === 'å®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰') {
            Logger.log(`  â­  ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã™ã§ã«å®Ÿç¸¾å·¥æ•°åˆ—ã‚ã‚Šï¼‰: ${sheetName}`);
            continue;
          }

          // 12åˆ—ç›®ï¼ˆLåˆ—ï¼‰ã«æ–°ã—ã„åˆ—ã‚’æŒ¿å…¥
          sheet.insertColumnAfter(11); // Kåˆ—ã®å¾Œã‚ã«æŒ¿å…¥

          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ2è¡Œç›®ï¼‰ã®12åˆ—ç›®ã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€ã‚’è¨­å®š
          sheet.getRange(2, 12).setValue('å®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰');

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ï¼ˆä»–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
          const headerCell = sheet.getRange(2, 12);
          headerCell.setBackground('#E8F4FD');
          headerCell.setHorizontalAlignment('center');
          headerCell.setVerticalAlignment('middle');

          // 1è¡Œç›®ã®12åˆ—ç›®ã‚‚åŒã˜è‰²ã§å¡—ã‚‹
          sheet.getRange(1, 12).setBackground('#E8F4FD');
          sheet.getRange(1, 12).setHorizontalAlignment('center');
          sheet.getRange(1, 12).setVerticalAlignment('middle');

          Logger.log(`  âœ“ å®Œäº†: ${sheetName}`);
          ganttCount++;

        } catch (error) {
          Logger.log(`  âœ— ã‚¨ãƒ©ãƒ¼ (${sheetName}): ${error.message}`);
          errorCount++;
        }
      }
    }

    Logger.log(`âœ“ Ganttã‚·ãƒ¼ãƒˆå‡¦ç†å®Œäº†: ${ganttCount}ä»¶`);

    // 2. å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’å‡¦ç†
    Logger.log('--- å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆã‚’å‡¦ç†ä¸­ ---');

    const allTasksSheet = ss.getSheetByName(CONFIG.SHEET_NAMES.ALL_TASKS);

    if (allTasksSheet) {
      try {
        // 1è¡Œç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‰ã®14åˆ—ç›®ï¼ˆNåˆ—ï¼‰ã®å€¤ã‚’ç¢ºèª
        const currentHeader = allTasksSheet.getRange(1, 14).getValue();

        // ã™ã§ã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (currentHeader === 'å®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰') {
          Logger.log('  â­  ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã™ã§ã«å®Ÿç¸¾å·¥æ•°åˆ—ã‚ã‚Šï¼‰: å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯');
        } else {
          // 14åˆ—ç›®ï¼ˆNåˆ—ï¼‰ã«æ–°ã—ã„åˆ—ã‚’æŒ¿å…¥
          allTasksSheet.insertColumnAfter(13); // Måˆ—ã®å¾Œã‚ã«æŒ¿å…¥

          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ1è¡Œç›®ï¼‰ã®14åˆ—ç›®ã«ã€Œå®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰ã€ã‚’è¨­å®š
          allTasksSheet.getRange(1, 14).setValue('å®Ÿç¸¾å·¥æ•°ï¼ˆhï¼‰');

          // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          const headerCell = allTasksSheet.getRange(1, 14);
          headerCell.setBackground('#4A90E2');
          headerCell.setFontColor('#FFFFFF');
          headerCell.setFontWeight('bold');
          headerCell.setHorizontalAlignment('center');

          // åˆ—å¹…ã‚’è¨­å®š
          allTasksSheet.setColumnWidth(14, 75);

          Logger.log('  âœ“ å®Œäº†: å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯');
        }
      } catch (error) {
        Logger.log(`  âœ— ã‚¨ãƒ©ãƒ¼ (å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯): ${error.message}`);
        errorCount++;
      }
    } else {
      Logger.log('  âš  å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
    }

    Logger.log('=== ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† ===');
    Logger.log(`æˆåŠŸ: ${ganttCount}ä»¶ã®Ganttã‚·ãƒ¼ãƒˆ + å…¨ã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆ / ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`);

    // Discordé€šçŸ¥
    sendDiscordNotification(
      `âœ… **å®Ÿç¸¾å·¥æ•°åˆ—ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†**\n\n` +
      `Ganttã‚·ãƒ¼ãƒˆ: ${ganttCount}ä»¶\n` +
      `å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒˆ: å‡¦ç†æ¸ˆã¿\n` +
      `ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`,
      false
    );

  } catch (error) {
    Logger.log('âœ— ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    sendDiscordNotification(
      `å®Ÿç¸¾å·¥æ•°åˆ—ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
    throw error;
  }
}

/**
 * ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼æ¤œçŸ¥: é…å»¶ã‚¿ã‚¹ã‚¯ã®å½±éŸ¿åˆ†æ
 *
 * ã“ã®é–¢æ•°ã¯é…å»¶ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡ºã—ã€ãã‚Œã‚‰ãŒä»–ã®ã‚¿ã‚¹ã‚¯ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’åˆ†æã—ã¾ã™ã€‚
 *
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿
 * @return {Object} åˆ†æçµæœ
 *   {
 *     delayedTasks: [é…å»¶ã‚¿ã‚¹ã‚¯ã®é…åˆ—],
 *     impactedTasks: {
 *       delayed_task_id: {
 *         impactedTaskIds: [å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¿ã‚¹ã‚¯IDã®é…åˆ—],
 *         criticalPathLength: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã®é•·ã•
 *       }
 *     },
 *     circularDependencies: [[å¾ªç’°ä¾å­˜ã‚¿ã‚¹ã‚¯IDã®é…åˆ—], ...],
 *     taskMap: { task_id: task_object }
 *   }
 */
function analyzeDependencyImpact(projectData) {
  try {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ

    const tasks = projectData.tasks || [];
    const delayedTasks = [];
    const taskMap = {}; // task_id -> task object
    const dependencyGraph = {}; // task_id -> [dependent task_ids] (ã“ã®ã‚¿ã‚¹ã‚¯ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã®ID)

    // 1. ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰ & é…å»¶ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
    Logger.log('--- é…å»¶ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡ºä¸­ ---');
    for (const task of tasks) {
      taskMap[task.task_id] = task;

      // é…å»¶ã‚¿ã‚¹ã‚¯åˆ¤å®š: çµ‚äº†æ—¥ < ä»Šæ—¥ && é€²æ—ç‡ < 100%
      if (task.end_date) {
        const endDate = new Date(task.end_date);
        endDate.setHours(0, 0, 0, 0);

        const progress = task.progress || 0;
        const progressPercent = progress <= 1 ? progress * 100 : progress;

        if (endDate < today && progressPercent < 100) {
          const daysOverdue = Math.floor((today - endDate) / (1000 * 60 * 60 * 24));
          delayedTasks.push({
            ...task,
            daysOverdue: daysOverdue
          });
          Logger.log(`  é…å»¶ã‚¿ã‚¹ã‚¯æ¤œå‡º: ${task.task_id} (${task.task_name}) - ${daysOverdue}æ—¥é…å»¶`);
        }
      }
    }

    Logger.log(`âœ“ é…å»¶ã‚¿ã‚¹ã‚¯: ${delayedTasks.length}ä»¶`);

    // 2. ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ï¼ˆé€†æ–¹å‘: ã©ã®ã‚¿ã‚¹ã‚¯ãŒè‡ªåˆ†ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‹ï¼‰
    Logger.log('--- ä¾å­˜é–¢ä¿‚ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ä¸­ ---');
    for (const task of tasks) {
      const dependencies = task.dependencies || [];
      for (const depTaskId of dependencies) {
        if (!dependencyGraph[depTaskId]) {
          dependencyGraph[depTaskId] = [];
        }
        dependencyGraph[depTaskId].push(task.task_id);
      }
    }

    // 3. å„é…å»¶ã‚¿ã‚¹ã‚¯ã«ã¤ã„ã¦å½±éŸ¿ç¯„å›²ã‚’åˆ†æï¼ˆDFS: æ·±ã•å„ªå…ˆæ¢ç´¢ï¼‰
    Logger.log('--- å½±éŸ¿ç¯„å›²ã‚’åˆ†æä¸­ ---');
    const impactedTasks = {}; // delayed_task_id -> { impactedTaskIds: [...], criticalPathLength: N }

    for (const delayedTask of delayedTasks) {
      const visited = new Set();
      const impactedTaskIds = [];
      let maxDepth = 0;

      // DFSã§å½±éŸ¿ç¯„å›²ã‚’æ¢ç´¢
      const dfs = (taskId, depth) => {
        if (visited.has(taskId)) {
          return; // æ—¢ã«è¨ªå•æ¸ˆã¿ï¼ˆå¾ªç’°ä¾å­˜ã®å ´åˆï¼‰
        }

        visited.add(taskId);
        maxDepth = Math.max(maxDepth, depth);

        // é…å»¶ã‚¿ã‚¹ã‚¯è‡ªèº«ã¯é™¤å¤–
        if (taskId !== delayedTask.task_id) {
          impactedTaskIds.push(taskId);
        }

        // ã“ã®ã‚¿ã‚¹ã‚¯ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’å†å¸°çš„ã«æ¢ç´¢
        const dependentTasks = dependencyGraph[taskId] || [];
        for (const dependentTaskId of dependentTasks) {
          dfs(dependentTaskId, depth + 1);
        }
      };

      dfs(delayedTask.task_id, 0);

      impactedTasks[delayedTask.task_id] = {
        impactedTaskIds: impactedTaskIds,
        criticalPathLength: maxDepth
      };

      Logger.log(`  ${delayedTask.task_id}: ${impactedTaskIds.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã«å½±éŸ¿, ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹é•·=${maxDepth}`);
    }

    // 4. å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º
    Logger.log('--- å¾ªç’°ä¾å­˜ã‚’æ¤œå‡ºä¸­ ---');
    const circularDependencies = detectCircularDependencies(tasks);

    if (circularDependencies.length > 0) {
      Logger.log(`âš  å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º: ${circularDependencies.length}ä»¶`);
      for (const cycle of circularDependencies) {
        Logger.log(`  å¾ªç’°: ${cycle.join(' -> ')}`);
      }
    } else {
      Logger.log('âœ“ å¾ªç’°ä¾å­˜ãªã—');
    }

    return {
      delayedTasks: delayedTasks,
      impactedTasks: impactedTasks,
      circularDependencies: circularDependencies,
      taskMap: taskMap
    };

  } catch (error) {
    Logger.log(`âœ— ä¾å­˜é–¢ä¿‚åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`);
    Logger.log(`âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`);
    throw error;
  }
}

/**
 * å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º
 *
 * ã‚¿ã‚¹ã‚¯é–“ã®ä¾å­˜é–¢ä¿‚ã«å¾ªç’°ãŒãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
 * å¾ªç’°ä¾å­˜ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚‰ã®ã‚¿ã‚¹ã‚¯IDã®ã‚µã‚¤ã‚¯ãƒ«ã‚’è¿”ã—ã¾ã™ã€‚
 *
 * @param {Array} tasks - ã‚¿ã‚¹ã‚¯é…åˆ—
 * @return {Array} å¾ªç’°ä¾å­˜ã®ãƒªã‚¹ãƒˆ [[taskId1, taskId2, ...], ...]
 */
function detectCircularDependencies(tasks) {
  const circularDeps = [];
  const visited = new Set();
  const recursionStack = new Set();
  const taskMap = {};

  // ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
  for (const task of tasks) {
    taskMap[task.task_id] = task;
  }

  // DFSã§å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º
  const dfs = (taskId, path) => {
    if (recursionStack.has(taskId)) {
      // å¾ªç’°ä¾å­˜ã‚’ç™ºè¦‹
      const cycleStart = path.indexOf(taskId);
      const cycle = path.slice(cycleStart).concat([taskId]);
      circularDeps.push(cycle);
      return true;
    }

    if (visited.has(taskId)) {
      return false;
    }

    visited.add(taskId);
    recursionStack.add(taskId);
    path.push(taskId);

    const task = taskMap[taskId];
    if (task && task.dependencies) {
      for (const depTaskId of task.dependencies) {
        dfs(depTaskId, path.slice());
      }
    }

    recursionStack.delete(taskId);
    return false;
  };

  // å…¨ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯
  for (const task of tasks) {
    if (!visited.has(task.task_id)) {
      dfs(task.task_id, []);
    }
  }

  return circularDeps;
}

/**
 * ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã®é€šçŸ¥ã‚’Discordã«é€ä¿¡
 *
 * é…å»¶ã‚¿ã‚¹ã‚¯ã¨ãã®å½±éŸ¿ç¯„å›²ã‚’Embedå½¢å¼ã§Discordã«é€šçŸ¥ã—ã¾ã™ã€‚
 *
 * @param {Object} impactReport - analyzeDependencyImpact()ã®æˆ»ã‚Šå€¤
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿
 * @param {Object} criticalPathReport - calculateCriticalPath()ã®æˆ»ã‚Šå€¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
 */
function sendDependencyBlockerNotification(impactReport, projectData, criticalPathReport) {
  try {
    if (!impactReport.delayedTasks || impactReport.delayedTasks.length === 0) {
      Logger.log('âœ“ é…å»¶ã‚¿ã‚¹ã‚¯ãŒãªã„ãŸã‚é€šçŸ¥ã‚’ã‚¹ã‚­ãƒƒãƒ—');
      return;
    }

    const embeds = [];

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±
    const projectName = projectData.project_name || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
    const projectId = projectData.project_id || '';

    // é…å»¶ã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’æ•´å½¢ï¼ˆæœ€å¤§5ä»¶ã¾ã§è¡¨ç¤ºï¼‰
    const delayedTasksInfo = impactReport.delayedTasks
      .slice(0, 5)
      .map(task => {
        const taskName = task.task_name || task.task_id;
        const daysOverdue = task.daysOverdue || 0;
        const impact = impactReport.impactedTasks[task.task_id];
        const impactCount = impact ? impact.impactedTaskIds.length : 0;
        const criticalPathLength = impact ? impact.criticalPathLength : 0;

        return `â€¢ **${taskName}**\n  - é…å»¶: ${daysOverdue}æ—¥\n  - å½±éŸ¿ã‚¿ã‚¹ã‚¯æ•°: ${impactCount}ä»¶\n  - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹é•·: ${criticalPathLength}`;
      })
      .join('\n\n');

    const moreCount = impactReport.delayedTasks.length > 5
      ? `\n\n... ä»–${impactReport.delayedTasks.length - 5}ä»¶ã®é…å»¶ã‚¿ã‚¹ã‚¯`
      : '';

    // å¾ªç’°ä¾å­˜æƒ…å ±
    let circularDepsInfo = '';
    if (impactReport.circularDependencies.length > 0) {
      circularDepsInfo = '\n\nâš ï¸ **å¾ªç’°ä¾å­˜ã‚’æ¤œå‡º**\n' +
        impactReport.circularDependencies
          .slice(0, 3)
          .map(cycle => `â€¢ ${cycle.join(' â†’ ')}`)
          .join('\n');

      if (impactReport.circularDependencies.length > 3) {
        circularDepsInfo += `\n... ä»–${impactReport.circularDependencies.length - 3}ä»¶`;
      }
    }

    const embed = {
      title: `âš ï¸ ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼æ¤œçŸ¥: ${projectName}`,
      description: delayedTasksInfo + moreCount + circularDepsInfo,
      color: 0xFF6B6B, // èµ¤è‰²
      footer: {
        text: `åˆè¨ˆ ${impactReport.delayedTasks.length}ä»¶ã®é…å»¶ã‚¿ã‚¹ã‚¯`
      },
      timestamp: new Date().toISOString()
    };

    // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹æƒ…å ±ã‚’è¿½åŠ 
    if (criticalPathReport && !criticalPathReport.skipped && !criticalPathReport.error) {
      embed.fields = [{
        name: 'ğŸ¯ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹æƒ…å ±',
        value: `ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‰€è¦æ™‚é–“: **${criticalPathReport.projectDuration}æ—¥**\n` +
               `ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¿ã‚¹ã‚¯æ•°: **${criticalPathReport.criticalTasks.length}ä»¶**\n` +
               `Near-Criticalã‚¿ã‚¹ã‚¯æ•°: **${criticalPathReport.nearCriticalTasks.length}ä»¶**`,
        inline: false
      }];
    }

    embeds.push(embed);

    // Discord Webhooké€ä¿¡
    const payload = { embeds: embeds };
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, options);
    const responseCode = response.getResponseCode();

    if (responseCode === 200 || responseCode === 204) {
      Logger.log(`âœ“ Discordé€šçŸ¥é€ä¿¡å®Œäº†: ${responseCode}`);
    } else {
      Logger.log(`âš  Discordé€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${responseCode}`);
      Logger.log(`ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${response.getContentText()}`);
    }

  } catch (error) {
    Logger.log(`âœ— Discordé€šçŸ¥ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    Logger.log(`âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`);
    throw error;
  }
}

/**
 * ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’è‡ªå‹•ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆãƒªã‚¬ãƒ¼ç”¨ï¼‰
 *
 * ã™ã¹ã¦ã®Ganttã‚·ãƒ¼ãƒˆã§é…å»¶ã‚¿ã‚¹ã‚¯ã®å½±éŸ¿ã‚’åˆ†æã—ã€Discordé€šçŸ¥ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
 *
 * ãƒˆãƒªã‚¬ãƒ¼è¨­å®š:
 * - é »åº¦: æ¯æ—¥9:00ã«å®Ÿè¡Œ
 * - è¨­å®šæ–¹æ³•: Apps Scriptã‚¨ãƒ‡ã‚£ã‚¿ã®ã€Œãƒˆãƒªã‚¬ãƒ¼ã€ã‹ã‚‰è¨­å®š
 */
function checkDependencyBlockers() {
  try {
    Logger.log('=== ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    // Ganttã‚·ãƒ¼ãƒˆã‚’æ¤œå‡º
    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/); // "X_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" ã¾ãŸã¯ "XXXX_ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå" å½¢å¼
    });

    Logger.log(`âœ“ Ganttã‚·ãƒ¼ãƒˆæ¤œå‡º: ${ganttSheets.length}ä»¶`);

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    let totalProjects = 0;
    let totalDelayed = 0;
    let totalImpacted = 0;
    let errorCount = 0;

    // å„Ganttã‚·ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    for (const ganttSheet of ganttSheets) {
      try {
        Logger.log(`--- ${ganttSheet.getName()} ã‚’ãƒã‚§ãƒƒã‚¯ä¸­ ---`);

        // Ganttã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Š
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);

        if (!projectData) {
          Logger.log(`âš  ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šå¤±æ•—: ${ganttSheet.getName()}`);
          errorCount++;
          continue;
        }

        // ä¾å­˜é–¢ä¿‚ã®å½±éŸ¿ã‚’åˆ†æ
        const impactReport = analyzeDependencyImpact(projectData);

        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹åˆ†æ
        const criticalPathReport = calculateCriticalPath(projectData);
        if (criticalPathReport && !criticalPathReport.skipped) {
          Logger.log(`[INFO] Critical path calculated for ${ganttSheet.getName()}: ${criticalPathReport.projectDuration} days`);
        }

        if (impactReport.delayedTasks.length > 0) {
          // Discordé€šçŸ¥ã‚’é€ä¿¡ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹æƒ…å ±ã‚’å«ã‚€ï¼‰
          sendDependencyBlockerNotification(impactReport, projectData, criticalPathReport);

          // Ganttã‚·ãƒ¼ãƒˆã§ãƒ–ãƒ­ãƒƒã‚¯ã‚¿ã‚¹ã‚¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          highlightBlockedTasks(ganttSheet, projectData, impactReport);

          // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          highlightCriticalPath(ganttSheet, projectData, criticalPathReport);

          totalDelayed += impactReport.delayedTasks.length;

          // å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¿ã‚¹ã‚¯æ•°ã‚’é›†è¨ˆ
          for (const delayedTaskId in impactReport.impactedTasks) {
            totalImpacted += impactReport.impactedTasks[delayedTaskId].impactedTaskIds.length;
          }

          Logger.log(`âœ“ ${ganttSheet.getName()}: ${impactReport.delayedTasks.length}ä»¶ã®é…å»¶ã‚¿ã‚¹ã‚¯æ¤œå‡º`);
        } else {
          Logger.log(`âœ“ ${ganttSheet.getName()}: é…å»¶ã‚¿ã‚¹ã‚¯ãªã—`);
        }

        totalProjects++;

      } catch (error) {
        Logger.log(`âœ— ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
        errorCount++;
      }
    }

    Logger.log('=== ãƒã‚§ãƒƒã‚¯å®Œäº† ===');
    Logger.log(`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${totalProjects}ä»¶ / é…å»¶ã‚¿ã‚¹ã‚¯: ${totalDelayed}ä»¶ / å½±éŸ¿ã‚¿ã‚¹ã‚¯: ${totalImpacted}ä»¶ / ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`);

    // ã‚µãƒãƒªãƒ¼é€šçŸ¥ï¼ˆé…å»¶ã‚¿ã‚¹ã‚¯ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
    if (totalDelayed > 0) {
      sendDiscordNotification(
        `ğŸ“Š **ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†**\n\n` +
        `ãƒã‚§ãƒƒã‚¯å¯¾è±¡: ${totalProjects}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\n` +
        `é…å»¶ã‚¿ã‚¹ã‚¯: ${totalDelayed}ä»¶\n` +
        `å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¿ã‚¹ã‚¯: ${totalImpacted}ä»¶\n` +
        `ã‚¨ãƒ©ãƒ¼: ${errorCount}ä»¶`,
        errorCount > 0
      );
    }

  } catch (error) {
    Logger.log('âœ— å…¨ä½“ã‚¨ãƒ©ãƒ¼: ' + error.message);
    Logger.log('âœ— ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + error.stack);
    sendDiscordNotification(
      `ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
    throw error;
  }
}

/**
 * ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã‚’è¨ˆç®—
 *
 * ã‚¿ã‚¹ã‚¯ã®ä¾å­˜é–¢ä¿‚ã‹ã‚‰ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ï¼ˆæœ€é•·çµŒè·¯ï¼‰ã‚’ç®—å‡ºã—ã¾ã™ã€‚
 * Kahn's Algorithmã«ã‚ˆã‚‹ãƒˆãƒãƒ­ã‚¸ã‚«ãƒ«ã‚½ãƒ¼ãƒˆ + Forward/Backward Passã§è¨ˆç®—ã€‚
 *
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆtasksé…åˆ—ã‚’å«ã‚€ï¼‰
 * @return {Object} ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹æƒ…å ±
 *   {
 *     criticalTasks: [task_id, ...],        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ä¸Šã®ã‚¿ã‚¹ã‚¯IDé…åˆ—
 *     taskMetrics: {
 *       task_id: {
 *         es: Number,    // æœ€æ—©é–‹å§‹æ™‚åˆ»ï¼ˆæ—¥æ•°ï¼‰
 *         ef: Number,    // æœ€æ—©çµ‚äº†æ™‚åˆ»ï¼ˆæ—¥æ•°ï¼‰
 *         ls: Number,    // æœ€é…é–‹å§‹æ™‚åˆ»ï¼ˆæ—¥æ•°ï¼‰
 *         lf: Number,    // æœ€é…çµ‚äº†æ™‚åˆ»ï¼ˆæ—¥æ•°ï¼‰
 *         slack: Number  // ã‚¹ãƒ©ãƒƒã‚¯ï¼ˆæ—¥æ•°ï¼‰
 *       }
 *     },
 *     nearCriticalTasks: [task_id, ...],    // Near-criticalï¼ˆSlack 1-2æ—¥ï¼‰
 *     projectDuration: Number                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æ‰€è¦æ—¥æ•°
 *   }
 */
function calculateCriticalPath(projectData) {
  const tasks = projectData.tasks;

  // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¿è­·: ã‚¿ã‚¹ã‚¯æ•°ãŒå¤šã™ãã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
  if (tasks.length > 500) {
    Logger.log('[WARNING] Too many tasks (' + tasks.length + '), skipping critical path analysis');
    return {
      criticalTasks: [],
      taskMetrics: {},
      nearCriticalTasks: [],
      projectDuration: 0,
      skipped: true
    };
  }

  // 1. ã‚¿ã‚¹ã‚¯ãƒãƒƒãƒ—æ§‹ç¯‰ï¼ˆID â†’ ã‚¿ã‚¹ã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  const taskMap = {};
  for (const task of tasks) {
    taskMap[task.task_id] = task;
  }

  // 2. ã‚°ãƒ©ãƒ•æ§‹ç¯‰ï¼ˆéš£æ¥ãƒªã‚¹ãƒˆå½¢å¼ï¼‰
  const adjacencyList = {};  // task_id â†’ [dependent_task_ids]
  const inDegree = {};       // task_id â†’ å…¥æ¬¡æ•°

  for (const task of tasks) {
    adjacencyList[task.task_id] = [];
    inDegree[task.task_id] = 0;
  }

  for (const task of tasks) {
    if (task.dependencies && task.dependencies.length > 0) {
      for (const depId of task.dependencies) {
        if (adjacencyList[depId]) {
          adjacencyList[depId].push(task.task_id);
          inDegree[task.task_id]++;
        }
      }
    }
  }

  // 3. ãƒˆãƒãƒ­ã‚¸ã‚«ãƒ«ã‚½ãƒ¼ãƒˆï¼ˆKahn's Algorithmï¼‰
  const queue = [];
  const topologicalOrder = [];

  for (const taskId in inDegree) {
    if (inDegree[taskId] === 0) {
      queue.push(taskId);
    }
  }

  while (queue.length > 0) {
    const current = queue.shift();
    topologicalOrder.push(current);

    for (const neighbor of adjacencyList[current]) {
      inDegree[neighbor]--;
      if (inDegree[neighbor] === 0) {
        queue.push(neighbor);
      }
    }
  }

  // å¾ªç’°ä¾å­˜ãƒã‚§ãƒƒã‚¯
  if (topologicalOrder.length !== tasks.length) {
    Logger.log('[ERROR] Circular dependency detected in critical path analysis');
    return {
      criticalTasks: [],
      taskMetrics: {},
      nearCriticalTasks: [],
      projectDuration: 0,
      error: 'circular_dependency'
    };
  }

  // 4. Forward Passï¼ˆES/EFè¨ˆç®—ï¼‰
  const taskMetrics = {};

  for (const taskId of topologicalOrder) {
    const task = taskMap[taskId];
    const duration = calculateTaskDuration(task.start_date, task.end_date);

    taskMetrics[taskId] = {
      es: 0,
      ef: 0,
      ls: 0,
      lf: 0,
      slack: 0,
      duration: duration
    };

    // å…ˆè¡Œã‚¿ã‚¹ã‚¯ã®æœ€å¤§EFã‚’è¨ˆç®—
    let maxEF = 0;
    if (task.dependencies && task.dependencies.length > 0) {
      for (const depId of task.dependencies) {
        if (taskMetrics[depId]) {
          maxEF = Math.max(maxEF, taskMetrics[depId].ef);
        }
      }
    }

    taskMetrics[taskId].es = maxEF;
    taskMetrics[taskId].ef = maxEF + duration;
  }

  // 5. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®æ‰€è¦æ™‚é–“ã‚’è¨ˆç®—
  let projectDuration = 0;
  for (const taskId in taskMetrics) {
    projectDuration = Math.max(projectDuration, taskMetrics[taskId].ef);
  }

  // 6. Backward Passï¼ˆLS/LFè¨ˆç®—ï¼‰
  for (let i = topologicalOrder.length - 1; i >= 0; i--) {
    const taskId = topologicalOrder[i];
    const task = taskMap[taskId];

    // å¾Œç¶šã‚¿ã‚¹ã‚¯ãŒãªã„å ´åˆã¯LF = EF
    if (adjacencyList[taskId].length === 0) {
      taskMetrics[taskId].lf = taskMetrics[taskId].ef;
    } else {
      // å¾Œç¶šã‚¿ã‚¹ã‚¯ã®æœ€å°LSã‚’è¨ˆç®—
      let minLS = Infinity;
      for (const successorId of adjacencyList[taskId]) {
        if (taskMetrics[successorId]) {
          minLS = Math.min(minLS, taskMetrics[successorId].ls);
        }
      }
      taskMetrics[taskId].lf = minLS;
    }

    taskMetrics[taskId].ls = taskMetrics[taskId].lf - taskMetrics[taskId].duration;
  }

  // 7. Slackè¨ˆç®—ã¨ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹/Near-criticalåˆ¤å®š
  const criticalTasks = [];
  const nearCriticalTasks = [];

  for (const taskId in taskMetrics) {
    const slack = taskMetrics[taskId].ls - taskMetrics[taskId].es;
    taskMetrics[taskId].slack = slack;

    if (slack === 0) {
      criticalTasks.push(taskId);
    } else if (slack > 0 && slack <= 2) {
      nearCriticalTasks.push(taskId);
    }
  }

  return {
    criticalTasks: criticalTasks,
    taskMetrics: taskMetrics,
    nearCriticalTasks: nearCriticalTasks,
    projectDuration: projectDuration
  };
}

/**
 * é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‹ã‚‰æ‰€è¦æ—¥æ•°ã‚’è¨ˆç®—
 *
 * @param {string} startDate - é–‹å§‹æ—¥ (YYYY-MM-DD)
 * @param {string} endDate - çµ‚äº†æ—¥ (YYYY-MM-DD)
 * @return {number} æ‰€è¦æ—¥æ•°
 */
function calculateTaskDuration(startDate, endDate) {
  if (!startDate || !endDate) return 1;  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1æ—¥

  const start = new Date(startDate);
  const end = new Date(endDate);
  const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

  return duration > 0 ? duration : 1;
}

// ============================================================
// ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒãƒ£ãƒ¼ãƒˆæ©Ÿèƒ½
// ============================================================

/**
 * æ—¥æ¬¡ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²
 *
 * ãƒˆãƒªã‚¬ãƒ¼çµŒç”±ã§æ¯æ—¥è‡ªå‹•å®Ÿè¡Œã•ã‚Œã€å…¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é€²æ—çŠ¶æ³ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
 * åŒæ—¥ã®ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ã¾ã™ã€‚
 */
function recordDailyBurndownData() {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheetManager = new SheetManager();
    const burndownSheet = sheetManager.getOrCreateBurndownSheet();

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dateStr = Utilities.formatDate(today, 'Asia/Tokyo', 'yyyy-MM-dd');

    // å…¨Ganttã‚·ãƒ¼ãƒˆã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­ã§åˆ¤å®šï¼‰
    const ganttSheets = ss.getSheets().filter(sheet =>
      sheet.getName().match(/^\d{1,4}_.+$/)
    );

    if (ganttSheets.length === 0) {
      Logger.log('[INFO] No Gantt sheets found for burndown recording');
      return;
    }

    Logger.log('[INFO] Recording burndown data for ' + ganttSheets.length + ' projects');

    for (const ganttSheet of ganttSheets) {
      try {
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);
        const projectName = projectData.project_name || ganttSheet.getName();

        // é€²æ—ç‡è¨ˆç®—
        const expectedProgress = calculateExpectedProgress(projectData);
        const completedTasks = projectData.tasks.filter(t => t.progress === 100).length;
        const totalTasks = projectData.tasks.length;
        const actualProgress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
        const remainingTasks = totalTasks - completedTasks;

        // ãƒ™ãƒ­ã‚·ãƒ†ã‚£è¨ˆç®—ï¼ˆéå»7æ—¥é–“ï¼‰
        const velocity = calculateVelocity(burndownSheet, projectName, 7);

        // å®Œäº†äºˆæ¸¬æ—¥è¨ˆç®—
        let predictedDate = '-';
        if (velocity > 0 && remainingTasks > 0) {
          const daysToCompletion = Math.ceil(remainingTasks / velocity);
          const predicted = new Date(today);
          predicted.setDate(predicted.getDate() + daysToCompletion);
          predictedDate = Utilities.formatDate(predicted, 'Asia/Tokyo', 'yyyy-MM-dd');
        }

        // æ—¢å­˜è¡Œã‚’æ¤œç´¢ï¼ˆåŒæ—¥ãƒ»åŒãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
        const existingRow = findBurndownRow(burndownSheet, today, projectName);

        const rowData = [
          dateStr,
          projectName,
          expectedProgress,
          actualProgress,
          remainingTasks,
          completedTasks,
          totalTasks,
          velocity,
          predictedDate
        ];

        if (existingRow > 0) {
          // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ã
          burndownSheet.getRange(existingRow, 1, 1, rowData.length).setValues([rowData]);
          Logger.log('[INFO] Updated burndown data for ' + projectName);
        } else {
          // æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
          burndownSheet.appendRow(rowData);
          Logger.log('[INFO] Recorded new burndown data for ' + projectName);
        }

      } catch (projectError) {
        Logger.log('[ERROR] Failed to record burndown for ' + ganttSheet.getName() + ': ' + projectError.message);
      }
    }

    // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ90æ—¥è¶…éï¼‰
    cleanupOldBurndownData(burndownSheet, 90);

    Logger.log('[INFO] Daily burndown recording completed');

  } catch (error) {
    Logger.log('[ERROR] recordDailyBurndownData failed: ' + error.message);
  }
}

/**
 * äºˆå®šé€²æ—ç‡ã®è¨ˆç®—
 *
 * ç¾åœ¨æ—¥æ™‚ã‚’åŸºæº–ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé–“ã«ãŠã‘ã‚‹ç†æƒ³çš„ãªé€²æ—ç‡ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
 * è¨ˆç®—å¼: (çµŒéæ—¥æ•° / å…¨ä½“æ—¥æ•°) Ã— 100
 *
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿
 * @return {Number} äºˆå®šé€²æ—ç‡ï¼ˆ%ã€å°æ•°ç¬¬1ä½ã¾ã§ï¼‰
 */
function calculateExpectedProgress(projectData) {
  try {
    const tasks = projectData.tasks || [];
    if (tasks.length === 0) return 0;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’å–å¾—
    let projectStart = null;
    let projectEnd = null;

    for (const task of tasks) {
      if (task.start_date) {
        if (!projectStart || task.start_date < projectStart) {
          projectStart = task.start_date;
        }
      }
      if (task.end_date) {
        if (!projectEnd || task.end_date > projectEnd) {
          projectEnd = task.end_date;
        }
      }
    }

    if (!projectStart || !projectEnd) {
      Logger.log('[WARNING] Cannot calculate expected progress: missing start/end dates');
      return 0;
    }

    // æ—¥æ•°è¨ˆç®—
    const totalDays = Math.max(1, Math.ceil((projectEnd - projectStart) / (1000 * 60 * 60 * 24)));
    const elapsedDays = Math.max(0, Math.ceil((today - projectStart) / (1000 * 60 * 60 * 24)));

    // äºˆå®šé€²æ—ç‡ã‚’è¨ˆç®—ï¼ˆ0ï½100%ã«ã‚¯ãƒªãƒƒãƒ—ï¼‰
    const expectedProgress = Math.min(100, Math.max(0, (elapsedDays / totalDays) * 100));

    return Math.round(expectedProgress * 10) / 10;  // å°æ•°ç¬¬1ä½ã¾ã§

  } catch (error) {
    Logger.log('[ERROR] calculateExpectedProgress failed: ' + error.message);
    return 0;
  }
}

/**
 * ãƒ™ãƒ­ã‚·ãƒ†ã‚£è¨ˆç®—ï¼ˆéå»Næ—¥é–“ã®å¹³å‡å®Œäº†ã‚¿ã‚¹ã‚¯æ•°/æ—¥ï¼‰
 *
 * @param {Sheet} burndownSheet - ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ
 * @param {String} projectName - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
 * @param {Number} days - éå»ä½•æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 7ï¼‰
 * @return {Number} ãƒ™ãƒ­ã‚·ãƒ†ã‚£ï¼ˆå°æ•°ç¬¬2ä½ã¾ã§ï¼‰
 */
function calculateVelocity(burndownSheet, projectName, days) {
  try {
    days = days || 7;
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const dataRange = burndownSheet.getDataRange();
    const values = dataRange.getValues();

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€è©²å½“ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
    const projectData = [];
    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      const recordDateStr = row[0];  // Aåˆ—: è¨˜éŒ²æ—¥
      const recordProjectName = row[1];  // Båˆ—: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
      const completedTasks = row[5];  // Fåˆ—: å®Œäº†ã‚¿ã‚¹ã‚¯æ•°

      if (recordProjectName !== projectName) continue;

      // æ—¥ä»˜è§£æ
      let recordDate;
      if (recordDateStr instanceof Date) {
        recordDate = new Date(recordDateStr);
      } else {
        recordDate = new Date(recordDateStr);
      }
      recordDate.setHours(0, 0, 0, 0);

      // éå»Næ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
      const daysDiff = Math.ceil((today - recordDate) / (1000 * 60 * 60 * 24));
      if (daysDiff >= 0 && daysDiff < days) {
        projectData.push({
          date: recordDate,
          completedTasks: completedTasks
        });
      }
    }

    if (projectData.length < 2) {
      // ãƒ‡ãƒ¼ã‚¿ä¸è¶³ã®å ´åˆã¯ãƒ™ãƒ­ã‚·ãƒ†ã‚£è¨ˆç®—ä¸å¯
      return 0;
    }

    // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
    projectData.sort((a, b) => a.date - b.date);

    // å®Œäº†ã‚¿ã‚¹ã‚¯æ•°ã®å·®åˆ†ã‚’è¨ˆç®—
    const oldest = projectData[0].completedTasks;
    const newest = projectData[projectData.length - 1].completedTasks;
    const taskDiff = newest - oldest;
    const dayDiff = Math.max(1, projectData.length - 1);

    const velocity = taskDiff / dayDiff;

    return Math.round(velocity * 100) / 100;  // å°æ•°ç¬¬2ä½ã¾ã§

  } catch (error) {
    Logger.log('[ERROR] calculateVelocity failed: ' + error.message);
    return 0;
  }
}

/**
 * ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ã‚·ãƒ¼ãƒˆã‹ã‚‰æŒ‡å®šæ—¥ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¡Œç•ªå·ã‚’æ¤œç´¢
 *
 * @param {Sheet} burndownSheet - ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ
 * @param {Date} date - è¨˜éŒ²æ—¥
 * @param {String} projectName - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
 * @return {Number} è¡Œç•ªå·ï¼ˆè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯0ï¼‰
 */
function findBurndownRow(burndownSheet, date, projectName) {
  try {
    const dateStr = Utilities.formatDate(date, 'Asia/Tokyo', 'yyyy-MM-dd');
    const dataRange = burndownSheet.getDataRange();
    const values = dataRange.getValues();

    for (let i = 1; i < values.length; i++) {  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
      const row = values[i];
      const recordDateStr = row[0];  // Aåˆ—: è¨˜éŒ²æ—¥
      const recordProjectName = row[1];  // Båˆ—: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå

      // æ—¥ä»˜æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦æ¯”è¼ƒ
      let compareDateStr;
      if (recordDateStr instanceof Date) {
        compareDateStr = Utilities.formatDate(recordDateStr, 'Asia/Tokyo', 'yyyy-MM-dd');
      } else {
        compareDateStr = recordDateStr;
      }

      if (compareDateStr === dateStr && recordProjectName === projectName) {
        return i + 1;  // è¡Œç•ªå·ï¼ˆ1-indexedï¼‰
      }
    }

    return 0;  // è¦‹ã¤ã‹ã‚‰ãªã„

  } catch (error) {
    Logger.log('[ERROR] findBurndownRow failed: ' + error.message);
    return 0;
  }
}

/**
 * å¤ã„ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ï¼ˆæŒ‡å®šæ—¥æ•°ã‚ˆã‚Šå‰ã®ãƒ‡ãƒ¼ã‚¿ï¼‰
 *
 * @param {Sheet} burndownSheet - ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ
 * @param {Number} days - ä¿æŒæ—¥æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 90æ—¥ï¼‰
 */
function cleanupOldBurndownData(burndownSheet, days) {
  try {
    days = days || 90;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const cutoffDate = new Date(today);
    cutoffDate.setDate(cutoffDate.getDate() - days);

    const dataRange = burndownSheet.getDataRange();
    const values = dataRange.getValues();

    // å‰Šé™¤å¯¾è±¡è¡Œã‚’åé›†ï¼ˆå¾Œã‚ã‹ã‚‰å‰Šé™¤ã™ã‚‹ãŸã‚é€†é †ï¼‰
    const rowsToDelete = [];
    for (let i = 1; i < values.length; i++) {  // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
      const row = values[i];
      const recordDateStr = row[0];  // Aåˆ—: è¨˜éŒ²æ—¥

      let recordDate;
      if (recordDateStr instanceof Date) {
        recordDate = new Date(recordDateStr);
      } else {
        recordDate = new Date(recordDateStr);
      }
      recordDate.setHours(0, 0, 0, 0);

      if (recordDate < cutoffDate) {
        rowsToDelete.push(i + 1);  // è¡Œç•ªå·ï¼ˆ1-indexedï¼‰
      }
    }

    // å¾Œã‚ã‹ã‚‰é †ã«å‰Šé™¤ï¼ˆè¡Œç•ªå·ãŒãšã‚Œãªã„ã‚ˆã†ã«ï¼‰
    rowsToDelete.reverse();
    for (const rowNum of rowsToDelete) {
      burndownSheet.deleteRow(rowNum);
    }

    if (rowsToDelete.length > 0) {
      Logger.log('[INFO] Cleaned up ' + rowsToDelete.length + ' old burndown records (older than ' + days + ' days)');
    }

  } catch (error) {
    Logger.log('[ERROR] cleanupOldBurndownData failed: ' + error.message);
  }
}

/**
 * ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒãƒ£ãƒ¼ãƒˆæ—¥æ¬¡è¨˜éŒ²ãƒˆãƒªã‚¬ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 *
 * ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æ¯æ—¥åˆå‰9æ™‚ã« recordDailyBurndownData() ã‚’è‡ªå‹•å®Ÿè¡Œã™ã‚‹
 * ãƒˆãƒªã‚¬ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¾ã™ã€‚æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚‹å ´åˆã¯é‡è¤‡ç™»éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚
 *
 * GASã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰æ‰‹å‹•ã§1å›å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
 */
function setupDailyBurndownTrigger() {
  try {
    const functionName = 'recordDailyBurndownData';

    // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ç¢ºèª
    const triggers = ScriptApp.getProjectTriggers();
    const existingTrigger = triggers.find(trigger =>
      trigger.getHandlerFunction() === functionName
    );

    if (existingTrigger) {
      Logger.log('[INFO] Daily burndown trigger already exists');
      Logger.log('âœ… ãƒˆãƒªã‚¬ãƒ¼ã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼ˆæ¯æ—¥åˆå‰9æ™‚å®Ÿè¡Œï¼‰');
      return;
    }

    // æ–°è¦ãƒˆãƒªã‚¬ãƒ¼ä½œæˆï¼ˆæ¯æ—¥åˆå‰9æ™‚ï¼‰
    ScriptApp.newTrigger(functionName)
      .timeBased()
      .atHour(9)
      .everyDays(1)
      .create();

    Logger.log('[INFO] Daily burndown trigger created successfully');
    Logger.log('âœ… ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸï¼');
    Logger.log('ğŸ“… æ¯æ—¥åˆå‰9æ™‚ã«ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè‡ªå‹•è¨˜éŒ²ã•ã‚Œã¾ã™');

  } catch (error) {
    Logger.log('[ERROR] Failed to setup trigger: ' + error.message);
    Logger.log('âŒ ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

/**
 * ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒãƒ£ãƒ¼ãƒˆæ—¥æ¬¡è¨˜éŒ²ãƒˆãƒªã‚¬ãƒ¼ã®å‰Šé™¤
 *
 * è‡ªå‹•è¨˜éŒ²ã‚’åœæ­¢ã—ãŸã„å ´åˆã«ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
 */
function removeDailyBurndownTrigger() {
  try {
    const functionName = 'recordDailyBurndownData';
    const triggers = ScriptApp.getProjectTriggers();

    let removedCount = 0;
    for (const trigger of triggers) {
      if (trigger.getHandlerFunction() === functionName) {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
      }
    }

    if (removedCount > 0) {
      Logger.log('[INFO] Removed ' + removedCount + ' trigger(s)');
      Logger.log('âœ… ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ' + removedCount + 'ä»¶ï¼‰');
      Logger.log('â¸ï¸  ãƒãƒ¼ãƒ³ãƒ€ã‚¦ãƒ³ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•è¨˜éŒ²ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ');
    } else {
      Logger.log('[INFO] No triggers found');
      Logger.log('â„¹ï¸  å‰Šé™¤å¯¾è±¡ã®ãƒˆãƒªã‚¬ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }

  } catch (error) {
    Logger.log('[ERROR] Failed to remove trigger: ' + error.message);
    Logger.log('âŒ ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

/**
 * å…¨ã‚·ãƒ¼ãƒˆåŒæœŸãƒˆãƒªã‚¬ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 *
 * ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æ¯æ—¥åˆå‰10æ™‚ã« syncAllSheets() ã‚’è‡ªå‹•å®Ÿè¡Œã™ã‚‹
 * ãƒˆãƒªã‚¬ãƒ¼ãŒç™»éŒ²ã•ã‚Œã¾ã™ã€‚æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚‹å ´åˆã¯é‡è¤‡ç™»éŒ²ã•ã‚Œã¾ã›ã‚“ã€‚
 *
 * GASã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰æ‰‹å‹•ã§1å›å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
 */
function setupSyncAllSheetsTrigger() {
  try {
    const functionName = 'syncAllSheets';

    // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’ç¢ºèª
    const triggers = ScriptApp.getProjectTriggers();
    const existingTrigger = triggers.find(trigger =>
      trigger.getHandlerFunction() === functionName
    );

    if (existingTrigger) {
      Logger.log('[INFO] Sync all sheets trigger already exists');
      Logger.log('âœ… ãƒˆãƒªã‚¬ãƒ¼ã¯æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼ˆæ¯æ—¥åˆå‰10æ™‚å®Ÿè¡Œï¼‰');
      return;
    }

    // æ–°è¦ãƒˆãƒªã‚¬ãƒ¼ä½œæˆï¼ˆæ¯æ—¥åˆå‰10æ™‚ï¼‰
    ScriptApp.newTrigger(functionName)
      .timeBased()
      .atHour(10)
      .everyDays(1)
      .create();

    Logger.log('[INFO] Sync all sheets trigger created successfully');
    Logger.log('âœ… ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸï¼');
    Logger.log('ğŸ“… æ¯æ—¥åˆå‰10æ™‚ã«å…¨ã‚·ãƒ¼ãƒˆåŒæœŸãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™');
    Logger.log('ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã€å…¨ã‚¿ã‚¹ã‚¯ã€æœŸæ—¥åˆ‡ã‚Œã‚¿ã‚¹ã‚¯ãŒæ›´æ–°ã•ã‚Œã¾ã™');

  } catch (error) {
    Logger.log('[ERROR] Failed to setup trigger: ' + error.message);
    Logger.log('âŒ ãƒˆãƒªã‚¬ãƒ¼è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

/**
 * å…¨ã‚·ãƒ¼ãƒˆåŒæœŸãƒˆãƒªã‚¬ãƒ¼ã®å‰Šé™¤
 *
 * è‡ªå‹•åŒæœŸã‚’åœæ­¢ã—ãŸã„å ´åˆã«ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
 */
function removeSyncAllSheetsTrigger() {
  try {
    const functionName = 'syncAllSheets';
    const triggers = ScriptApp.getProjectTriggers();

    let removedCount = 0;
    for (const trigger of triggers) {
      if (trigger.getHandlerFunction() === functionName) {
        ScriptApp.deleteTrigger(trigger);
        removedCount++;
      }
    }

    if (removedCount > 0) {
      Logger.log('[INFO] Removed ' + removedCount + ' trigger(s)');
      Logger.log('âœ… ãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼ˆ' + removedCount + 'ä»¶ï¼‰');
      Logger.log('â¸ï¸  å…¨ã‚·ãƒ¼ãƒˆåŒæœŸã®è‡ªå‹•å®Ÿè¡ŒãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ');
    } else {
      Logger.log('[INFO] No triggers found');
      Logger.log('â„¹ï¸  å‰Šé™¤å¯¾è±¡ã®ãƒˆãƒªã‚¬ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }

  } catch (error) {
    Logger.log('[ERROR] Failed to remove trigger: ' + error.message);
    Logger.log('âŒ ãƒˆãƒªã‚¬ãƒ¼å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 *
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿
 * @param {Date} today - åŸºæº–æ—¥
 * @return {Object} ãƒ¬ãƒãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
function generateProjectHealthReport(projectData, today) {
  try {
    today = today || new Date();
    today.setHours(0, 0, 0, 0);

    const tasks = projectData.tasks || [];
    const projectName = projectData.project_name || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';

    // åŸºæœ¬çµ±è¨ˆ
    const totalTasks = tasks.length;
    let completedTasks = 0;
    let overdueTasks = 0;
    let totalProgress = 0;

    // æ‹…å½“è€…åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰
    const assigneeWorkload = {};

    // ä»Šé€±æœŸé™ã€æ¥é€±é–‹å§‹ã®ã‚¿ã‚¹ã‚¯
    const thisWeekDueTasks = [];
    const nextWeekStartTasks = [];

    // ä»Šé€±ã®ç¯„å›²ï¼ˆæ—¥æ›œæ—¥ï½åœŸæ›œæ—¥ï¼‰
    const thisWeekEnd = new Date(today);
    thisWeekEnd.setDate(today.getDate() + (6 - today.getDay())); // æ¬¡ã®åœŸæ›œæ—¥
    thisWeekEnd.setHours(23, 59, 59, 999);

    // æ¥é€±ã®ç¯„å›²
    const nextWeekStart = new Date(thisWeekEnd);
    nextWeekStart.setDate(thisWeekEnd.getDate() + 1);
    nextWeekStart.setHours(0, 0, 0, 0);

    const nextWeekEnd = new Date(nextWeekStart);
    nextWeekEnd.setDate(nextWeekStart.getDate() + 6);
    nextWeekEnd.setHours(23, 59, 59, 999);

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®é–‹å§‹æ—¥ãƒ»çµ‚äº†æ—¥ã‚’å–å¾—
    let projectStartDate = null;
    let projectEndDate = null;

    for (const task of tasks) {
      // é€²æ—ç‡ã®æ­£è¦åŒ–
      const progress = task.progress || 0;
      const progressPercent = progress <= 1 ? progress * 100 : progress;
      totalProgress += progressPercent;

      if (progressPercent >= 100) {
        completedTasks++;
      }

      // æœŸæ—¥åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
      if (task.end_date) {
        const endDate = new Date(task.end_date);
        endDate.setHours(0, 0, 0, 0);

        if (endDate < today && progressPercent < 100) {
          overdueTasks++;
        }

        // ä»Šé€±æœŸé™ã®ã‚¿ã‚¹ã‚¯
        if (endDate >= today && endDate <= thisWeekEnd && progressPercent < 100) {
          thisWeekDueTasks.push(task);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ‚äº†æ—¥ã®æ›´æ–°
        if (!projectEndDate || endDate > projectEndDate) {
          projectEndDate = endDate;
        }
      }

      // é–‹å§‹æ—¥ãƒã‚§ãƒƒã‚¯
      if (task.start_date) {
        const startDate = new Date(task.start_date);
        startDate.setHours(0, 0, 0, 0);

        // æ¥é€±é–‹å§‹ã®ã‚¿ã‚¹ã‚¯
        if (startDate >= nextWeekStart && startDate <= nextWeekEnd) {
          nextWeekStartTasks.push(task);
        }

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ—¥ã®æ›´æ–°
        if (!projectStartDate || startDate < projectStartDate) {
          projectStartDate = startDate;
        }
      }

      // æ‹…å½“è€…åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰
      const assignee = task.assignee || 'æœªå‰²ã‚Šå½“ã¦';
      if (!assigneeWorkload[assignee]) {
        assigneeWorkload[assignee] = {
          totalTasks: 0,
          completedTasks: 0,
          inProgressTasks: 0,
          overdueTasks: 0
        };
      }

      assigneeWorkload[assignee].totalTasks++;

      if (progressPercent >= 100) {
        assigneeWorkload[assignee].completedTasks++;
      } else if (progressPercent > 0) {
        assigneeWorkload[assignee].inProgressTasks++;
      }

      if (task.end_date) {
        const endDate = new Date(task.end_date);
        endDate.setHours(0, 0, 0, 0);
        if (endDate < today && progressPercent < 100) {
          assigneeWorkload[assignee].overdueTasks++;
        }
      }
    }

    // å¹³å‡é€²æ—ç‡
    const avgProgress = totalTasks > 0 ? totalProgress / totalTasks : 0;

    // äºˆå®šé€²æ—ç‡ã®è¨ˆç®—
    let expectedProgress = 0;
    let riskScore = 0;
    let riskLevel = 'ğŸŸ¢ä½';

    if (projectStartDate && projectEndDate) {
      const totalDuration = projectEndDate - projectStartDate;
      const elapsedDuration = today - projectStartDate;

      if (totalDuration > 0 && elapsedDuration >= 0) {
        expectedProgress = (elapsedDuration / totalDuration) * 100;
        expectedProgress = Math.min(100, Math.max(0, expectedProgress)); // 0-100%ã«åˆ¶é™

        // ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—
        riskScore = expectedProgress - avgProgress;

        // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®š
        if (riskScore > 20) {
          riskLevel = 'ğŸ”´é«˜';
        } else if (riskScore > 10) {
          riskLevel = 'ğŸŸ¡ä¸­';
        } else {
          riskLevel = 'ğŸŸ¢ä½';
        }
      }
    }

    return {
      projectName: projectName,
      totalTasks: totalTasks,
      completedTasks: completedTasks,
      overdueTasks: overdueTasks,
      avgProgress: Math.round(avgProgress * 10) / 10, // å°æ•°ç‚¹1æ¡
      expectedProgress: Math.round(expectedProgress * 10) / 10,
      riskScore: Math.round(riskScore * 10) / 10,
      riskLevel: riskLevel,
      assigneeWorkload: assigneeWorkload,
      thisWeekDueTasks: thisWeekDueTasks,
      nextWeekStartTasks: nextWeekStartTasks
    };
  } catch (error) {
    Logger.log(`âœ— ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¥å…¨æ€§ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
    throw error;
  }
}

/**
 * é€±æ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
 */
function sendWeeklyReport() {
  try {
    Logger.log('=== é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹ ===');

    const today = new Date();
    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/);
    });

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    const reports = [];
    let totalProjects = 0;
    let totalTasks = 0;
    let totalCompleted = 0;
    let totalOverdue = 0;
    let highRiskProjects = 0;
    let mediumRiskProjects = 0;
    let lowRiskProjects = 0;

    // å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    for (const ganttSheet of ganttSheets) {
      try {
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);
        if (!projectData) continue;

        const report = generateProjectHealthReport(projectData, today);
        reports.push(report);

        totalProjects++;
        totalTasks += report.totalTasks;
        totalCompleted += report.completedTasks;
        totalOverdue += report.overdueTasks;

        if (report.riskLevel === 'ğŸ”´é«˜') {
          highRiskProjects++;
        } else if (report.riskLevel === 'ğŸŸ¡ä¸­') {
          mediumRiskProjects++;
        } else {
          lowRiskProjects++;
        }
      } catch (error) {
        Logger.log(`âœ— ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
      }
    }

    // é€±æ¬¡ã‚µãƒãƒªãƒ¼
    const overallProgress = totalTasks > 0
      ? Math.round((totalCompleted / totalTasks) * 100)
      : 0;

    let summaryText = `**ğŸ“Š é€±æ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**\n\n`;
    summaryText += `**å…¨ä½“ã‚µãƒãƒªãƒ¼**\n`;
    summaryText += `â€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°: ${totalProjects}ä»¶\n`;
    summaryText += `â€¢ å…¨ã‚¿ã‚¹ã‚¯æ•°: ${totalTasks}ä»¶\n`;
    summaryText += `â€¢ å®Œäº†ã‚¿ã‚¹ã‚¯: ${totalCompleted}ä»¶ (${overallProgress}%)\n`;
    summaryText += `â€¢ æœŸæ—¥åˆ‡ã‚Œ: ${totalOverdue}ä»¶\n`;
    summaryText += `â€¢ ãƒªã‚¹ã‚¯çŠ¶æ³: ğŸ”´${highRiskProjects}ä»¶ / ğŸŸ¡${mediumRiskProjects}ä»¶ / ğŸŸ¢${lowRiskProjects}ä»¶\n\n`;

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥è©³ç´°ï¼ˆãƒªã‚¹ã‚¯é«˜ã„é †ï¼‰
    const sortedReports = reports.sort((a, b) => {
      const riskOrder = { 'ğŸ”´é«˜': 3, 'ğŸŸ¡ä¸­': 2, 'ğŸŸ¢ä½': 1 };
      return riskOrder[b.riskLevel] - riskOrder[a.riskLevel];
    });

    summaryText += `**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥çŠ¶æ³**\n`;
    for (const report of sortedReports.slice(0, 10)) {
      const progressPercent = report.totalTasks > 0
        ? Math.round((report.completedTasks / report.totalTasks) * 100)
        : 0;

      summaryText += `\n${report.riskLevel} **${report.projectName}**\n`;
      summaryText += `  é€²æ—: ${progressPercent}% (${report.completedTasks}/${report.totalTasks}ä»¶)`;

      if (report.overdueTasks > 0) {
        summaryText += ` | æœŸæ—¥åˆ‡ã‚Œ: ${report.overdueTasks}ä»¶`;
      }

      if (report.thisWeekDueTasks.length > 0) {
        summaryText += ` | ä»Šé€±æœŸé™: ${report.thisWeekDueTasks.length}ä»¶`;
      }

      summaryText += `\n`;
    }

    if (sortedReports.length > 10) {
      summaryText += `\n... ä»–${sortedReports.length - 10}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\n`;
    }

    // ä»Šé€±æœŸé™ãƒ»æ¥é€±é–‹å§‹ã®ã‚¿ã‚¹ã‚¯é›†è¨ˆ
    const allThisWeekDueTasks = [];
    const allNextWeekStartTasks = [];

    for (const report of reports) {
      for (const task of report.thisWeekDueTasks) {
        allThisWeekDueTasks.push({
          projectName: report.projectName,
          ...task
        });
      }

      for (const task of report.nextWeekStartTasks) {
        allNextWeekStartTasks.push({
          projectName: report.projectName,
          ...task
        });
      }
    }

    // ä»Šé€±æœŸé™ã‚¿ã‚¹ã‚¯
    if (allThisWeekDueTasks.length > 0) {
      summaryText += `\n**ğŸ“… ä»Šé€±å®Œäº†äºˆå®šã‚¿ã‚¹ã‚¯ (${allThisWeekDueTasks.length}ä»¶)**\n`;

      for (const task of allThisWeekDueTasks.slice(0, 10)) {
        const taskName = task.task_name || task.task_id;
        const endDate = new Date(task.end_date);
        const dateStr = `${endDate.getMonth() + 1}/${endDate.getDate()}`;

        summaryText += `â€¢ ${taskName} (${task.projectName}) - ${dateStr}\n`;
      }

      if (allThisWeekDueTasks.length > 10) {
        summaryText += `... ä»–${allThisWeekDueTasks.length - 10}ä»¶\n`;
      }
    }

    // æ¥é€±é–‹å§‹ã‚¿ã‚¹ã‚¯
    if (allNextWeekStartTasks.length > 0) {
      summaryText += `\n**ğŸš€ æ¥é€±é–‹å§‹äºˆå®šã‚¿ã‚¹ã‚¯ (${allNextWeekStartTasks.length}ä»¶)**\n`;

      for (const task of allNextWeekStartTasks.slice(0, 10)) {
        const taskName = task.task_name || task.task_id;
        const startDate = new Date(task.start_date);
        const dateStr = `${startDate.getMonth() + 1}/${startDate.getDate()}`;

        summaryText += `â€¢ ${taskName} (${task.projectName}) - ${dateStr}\n`;
      }

      if (allNextWeekStartTasks.length > 10) {
        summaryText += `... ä»–${allNextWeekStartTasks.length - 10}ä»¶\n`;
      }
    }

    // Discordé€šçŸ¥é€ä¿¡
    const payload = {
      embeds: [{
        title: 'ğŸ“Š é€±æ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆ',
        description: summaryText,
        color: highRiskProjects > 0 ? 0xFF6B6B : (mediumRiskProjects > 0 ? 0xFFA726 : 0x66BB6A),
        footer: { text: `ç”Ÿæˆæ—¥æ™‚: ${today.toLocaleDateString('ja-JP')}` },
        timestamp: new Date().toISOString()
      }]
    };

    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, options);
    Logger.log(`âœ“ é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†: ${response.getResponseCode()}`);
    Logger.log(`âœ“ ${totalProjects}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ¬ãƒãƒ¼ãƒˆ`);

  } catch (error) {
    Logger.log('âœ— é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message);
    sendDiscordNotification(
      `é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
    throw error;
  }
}

/**
 * æœˆæ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
 */
function sendMonthlyReport() {
  try {
    Logger.log('=== æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹ ===');

    const today = new Date();
    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/);
    });

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    const reports = [];
    let totalProjects = 0;
    let totalTasks = 0;
    let totalCompleted = 0;
    let totalOverdue = 0;
    let highRiskProjects = 0;
    let mediumRiskProjects = 0;
    let lowRiskProjects = 0;

    // å…ˆæœˆãƒ»ä»Šæœˆã®ç¯„å›²ã‚’è¨ˆç®—
    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    thisMonthStart.setHours(0, 0, 0, 0);

    const thisMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    thisMonthEnd.setHours(23, 59, 59, 999);

    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    lastMonthStart.setHours(0, 0, 0, 0);

    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
    lastMonthEnd.setHours(23, 59, 59, 999);

    let lastMonthCompletedCount = 0;
    let thisMonthTargetCount = 0;

    // å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    for (const ganttSheet of ganttSheets) {
      try {
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);
        if (!projectData) continue;

        const report = generateProjectHealthReport(projectData, today);
        reports.push(report);

        totalProjects++;
        totalTasks += report.totalTasks;
        totalCompleted += report.completedTasks;
        totalOverdue += report.overdueTasks;

        if (report.riskLevel === 'ğŸ”´é«˜') {
          highRiskProjects++;
        } else if (report.riskLevel === 'ğŸŸ¡ä¸­') {
          mediumRiskProjects++;
        } else {
          lowRiskProjects++;
        }

        // å…ˆæœˆå®Œäº†ã‚¿ã‚¹ã‚¯ã¨ä»Šæœˆç›®æ¨™ã‚¿ã‚¹ã‚¯ã®ã‚«ã‚¦ãƒ³ãƒˆ
        for (const task of projectData.tasks) {
          const progress = task.progress || 0;
          const progressPercent = progress <= 1 ? progress * 100 : progress;

          // å…ˆæœˆå®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ï¼ˆå…ˆæœˆä¸­ã«100%ã«ãªã£ãŸã‚‚ã®ï¼‰
          if (progressPercent >= 100 && task.end_date) {
            const endDate = new Date(task.end_date);
            if (endDate >= lastMonthStart && endDate <= lastMonthEnd) {
              lastMonthCompletedCount++;
            }
          }

          // ä»ŠæœˆæœŸé™ã®ã‚¿ã‚¹ã‚¯ï¼ˆæœªå®Œäº†ï¼‰
          if (progressPercent < 100 && task.end_date) {
            const endDate = new Date(task.end_date);
            if (endDate >= thisMonthStart && endDate <= thisMonthEnd) {
              thisMonthTargetCount++;
            }
          }
        }

      } catch (error) {
        Logger.log(`âœ— ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
      }
    }

    // æœˆæ¬¡ã‚µãƒãƒªãƒ¼
    const overallProgress = totalTasks > 0
      ? Math.round((totalCompleted / totalTasks) * 100)
      : 0;

    let summaryText = `**ğŸ“Š æœˆæ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**\n\n`;
    summaryText += `**å…¨ä½“ã‚µãƒãƒªãƒ¼**\n`;
    summaryText += `â€¢ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°: ${totalProjects}ä»¶\n`;
    summaryText += `â€¢ å…¨ã‚¿ã‚¹ã‚¯æ•°: ${totalTasks}ä»¶\n`;
    summaryText += `â€¢ å®Œäº†ã‚¿ã‚¹ã‚¯: ${totalCompleted}ä»¶ (${overallProgress}%)\n`;
    summaryText += `â€¢ æœŸæ—¥åˆ‡ã‚Œ: ${totalOverdue}ä»¶\n`;
    summaryText += `â€¢ ãƒªã‚¹ã‚¯çŠ¶æ³: ğŸ”´${highRiskProjects}ä»¶ / ğŸŸ¡${mediumRiskProjects}ä»¶ / ğŸŸ¢${lowRiskProjects}ä»¶\n\n`;

    // æœˆæ¬¡å›ºæœ‰æƒ…å ±
    summaryText += `**æœˆæ¬¡çµ±è¨ˆ**\n`;
    summaryText += `â€¢ å…ˆæœˆå®Œäº†ã‚¿ã‚¹ã‚¯: ${lastMonthCompletedCount}ä»¶\n`;
    summaryText += `â€¢ ä»Šæœˆç›®æ¨™ã‚¿ã‚¹ã‚¯: ${thisMonthTargetCount}ä»¶\n\n`;

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥è©³ç´°ï¼ˆãƒªã‚¹ã‚¯é«˜ã„é †ï¼‰
    const sortedReports = reports.sort((a, b) => {
      const riskOrder = { 'ğŸ”´é«˜': 3, 'ğŸŸ¡ä¸­': 2, 'ğŸŸ¢ä½': 1 };
      return riskOrder[b.riskLevel] - riskOrder[a.riskLevel];
    });

    summaryText += `**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥çŠ¶æ³**\n`;
    for (const report of sortedReports.slice(0, 10)) {
      const progressPercent = report.totalTasks > 0
        ? Math.round((report.completedTasks / report.totalTasks) * 100)
        : 0;

      summaryText += `\n${report.riskLevel} **${report.projectName}**\n`;
      summaryText += `  é€²æ—: ${progressPercent}% (${report.completedTasks}/${report.totalTasks}ä»¶)`;

      if (report.overdueTasks > 0) {
        summaryText += ` | æœŸæ—¥åˆ‡ã‚Œ: ${report.overdueTasks}ä»¶`;
      }

      summaryText += `\n`;
    }

    if (sortedReports.length > 10) {
      summaryText += `\n... ä»–${sortedReports.length - 10}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\n`;
    }

    // ä»Šé€±æœŸé™ãƒ»æ¥é€±é–‹å§‹ã®ã‚¿ã‚¹ã‚¯é›†è¨ˆ
    const allThisWeekDueTasks = [];
    const allNextWeekStartTasks = [];

    for (const report of reports) {
      for (const task of report.thisWeekDueTasks) {
        allThisWeekDueTasks.push({
          projectName: report.projectName,
          ...task
        });
      }

      for (const task of report.nextWeekStartTasks) {
        allNextWeekStartTasks.push({
          projectName: report.projectName,
          ...task
        });
      }
    }

    // ä»Šé€±æœŸé™ã‚¿ã‚¹ã‚¯
    if (allThisWeekDueTasks.length > 0) {
      summaryText += `\n**ğŸ“… ä»Šé€±å®Œäº†äºˆå®šã‚¿ã‚¹ã‚¯ (${allThisWeekDueTasks.length}ä»¶)**\n`;

      for (const task of allThisWeekDueTasks.slice(0, 10)) {
        const taskName = task.task_name || task.task_id;
        const endDate = new Date(task.end_date);
        const dateStr = `${endDate.getMonth() + 1}/${endDate.getDate()}`;

        summaryText += `â€¢ ${taskName} (${task.projectName}) - ${dateStr}\n`;
      }

      if (allThisWeekDueTasks.length > 10) {
        summaryText += `... ä»–${allThisWeekDueTasks.length - 10}ä»¶\n`;
      }
    }

    // æ¥é€±é–‹å§‹ã‚¿ã‚¹ã‚¯
    if (allNextWeekStartTasks.length > 0) {
      summaryText += `\n**ğŸš€ æ¥é€±é–‹å§‹äºˆå®šã‚¿ã‚¹ã‚¯ (${allNextWeekStartTasks.length}ä»¶)**\n`;

      for (const task of allNextWeekStartTasks.slice(0, 10)) {
        const taskName = task.task_name || task.task_id;
        const startDate = new Date(task.start_date);
        const dateStr = `${startDate.getMonth() + 1}/${startDate.getDate()}`;

        summaryText += `â€¢ ${taskName} (${task.projectName}) - ${dateStr}\n`;
      }

      if (allNextWeekStartTasks.length > 10) {
        summaryText += `... ä»–${allNextWeekStartTasks.length - 10}ä»¶\n`;
      }
    }

    // Discordé€šçŸ¥é€ä¿¡
    const payload = {
      embeds: [{
        title: 'ğŸ“Š æœˆæ¬¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒãƒ¼ãƒˆ',
        description: summaryText,
        color: highRiskProjects > 0 ? 0xFF6B6B : (mediumRiskProjects > 0 ? 0xFFA726 : 0x66BB6A),
        footer: { text: `ç”Ÿæˆæ—¥æ™‚: ${today.toLocaleDateString('ja-JP')}` },
        timestamp: new Date().toISOString()
      }]
    };

    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, options);
    Logger.log(`âœ“ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†: ${response.getResponseCode()}`);
    Logger.log(`âœ“ ${totalProjects}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ¬ãƒãƒ¼ãƒˆ`);

  } catch (error) {
    Logger.log('âœ— æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message);
    sendDiscordNotification(
      `æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
    throw error;
  }
}

/**
 * è¦‹ç©ç²¾åº¦è¨ˆç®—
 *
 * @param {Object} projectData - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿
 * @return {Object} ç²¾åº¦åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
 */
function calculateEstimationAccuracy(projectData) {
  try {
    const projectName = projectData.project_name || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ';
    const tasks = projectData.tasks || [];

    // å®Ÿç¸¾å·¥æ•°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹å®Œäº†ã‚¿ã‚¹ã‚¯ã‚’æŠ½å‡º
    const completedTasksWithActual = [];
    const assigneeData = {};

    for (const task of tasks) {
      const progress = task.progress || 0;
      const progressPercent = progress <= 1 ? progress * 100 : progress;

      // å®Œäº†ã‚¿ã‚¹ã‚¯ã‹ã¤è¦‹ç©ãƒ»å®Ÿç¸¾ã®ä¸¡æ–¹ãŒã‚ã‚‹
      if (progressPercent >= 100 && task.estimated_hours && task.actual_hours) {
        const estimated = parseFloat(task.estimated_hours);
        const actual = parseFloat(task.actual_hours);

        if (estimated > 0 && actual > 0) {
          // èª¤å·®ç‡è¨ˆç®—: (å®Ÿç¸¾ - è¦‹ç©) / è¦‹ç© Ã— 100
          const errorRate = ((actual - estimated) / estimated) * 100;
          const absoluteError = Math.abs(errorRate);

          const taskAccuracy = {
            task_id: task.task_id,
            task_name: task.task_name || task.task_id,
            assignee: task.assignee || 'æœªå‰²ã‚Šå½“ã¦',
            estimated: estimated,
            actual: actual,
            errorRate: Math.round(errorRate * 10) / 10, // å°æ•°ç‚¹1æ¡
            absoluteError: Math.round(absoluteError * 10) / 10
          };

          completedTasksWithActual.push(taskAccuracy);

          // æ‹…å½“è€…åˆ¥ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆ
          const assignee = task.assignee || 'æœªå‰²ã‚Šå½“ã¦';
          if (!assigneeData[assignee]) {
            assigneeData[assignee] = {
              totalTasks: 0,
              totalEstimated: 0,
              totalActual: 0,
              totalErrorRate: 0
            };
          }

          assigneeData[assignee].totalTasks++;
          assigneeData[assignee].totalEstimated += estimated;
          assigneeData[assignee].totalActual += actual;
          assigneeData[assignee].totalErrorRate += errorRate;
        }
      }
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ç²¾åº¦
    let overallAccuracy = 0;
    let totalEstimated = 0;
    let totalActual = 0;

    if (completedTasksWithActual.length > 0) {
      for (const taskAcc of completedTasksWithActual) {
        totalEstimated += taskAcc.estimated;
        totalActual += taskAcc.actual;
      }

      if (totalEstimated > 0) {
        overallAccuracy = ((totalActual - totalEstimated) / totalEstimated) * 100;
        overallAccuracy = Math.round(overallAccuracy * 10) / 10;
      }
    }

    // æ‹…å½“è€…åˆ¥ç²¾åº¦
    const assigneeAccuracy = [];
    for (const assignee in assigneeData) {
      const data = assigneeData[assignee];
      const avgErrorRate = data.totalTasks > 0
        ? data.totalErrorRate / data.totalTasks
        : 0;

      assigneeAccuracy.push({
        assignee: assignee,
        totalTasks: data.totalTasks,
        totalEstimated: Math.round(data.totalEstimated * 10) / 10,
        totalActual: Math.round(data.totalActual * 10) / 10,
        avgErrorRate: Math.round(avgErrorRate * 10) / 10
      });
    }

    // èª¤å·®ç‡é †ã«ã‚½ãƒ¼ãƒˆ
    assigneeAccuracy.sort((a, b) => Math.abs(b.avgErrorRate) - Math.abs(a.avgErrorRate));

    // æœ€ã‚‚èª¤å·®ãŒå¤§ãã„ã‚¿ã‚¹ã‚¯ï¼ˆä¸Šä½5ä»¶ï¼‰
    const worstTasks = completedTasksWithActual
      .sort((a, b) => b.absoluteError - a.absoluteError)
      .slice(0, 5);

    return {
      projectName: projectName,
      overallAccuracy: overallAccuracy,
      completedTasksWithActual: completedTasksWithActual.length,
      totalEstimated: Math.round(totalEstimated * 10) / 10,
      totalActual: Math.round(totalActual * 10) / 10,
      assigneeAccuracy: assigneeAccuracy,
      worstTasks: worstTasks
    };
  } catch (error) {
    Logger.log(`âœ— è¦‹ç©ç²¾åº¦è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    throw error;
  }
}

/**
 * è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡
 */
function sendEstimationAccuracyReport() {
  try {
    Logger.log('=== è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹ ===');

    const sheetManager = new SheetManager();
    const ss = sheetManager.ss;
    const allSheets = ss.getSheets();

    const ganttSheets = allSheets.filter(sheet => {
      const name = sheet.getName();
      return name.match(/^\d{1,4}_.+$/);
    });

    if (ganttSheets.length === 0) {
      Logger.log('âš  Ganttã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
      return;
    }

    const accuracyReports = [];
    let totalProjects = 0;
    let totalTasksWithActual = 0;
    let overallTotalEstimated = 0;
    let overallTotalActual = 0;

    const allAssigneeData = {};
    const allWorstTasks = [];

    // å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç²¾åº¦åˆ†æ
    for (const ganttSheet of ganttSheets) {
      try {
        const projectData = sheetManager.readProjectDataFromSheet(ganttSheet);
        if (!projectData) continue;

        const accuracy = calculateEstimationAccuracy(projectData);

        if (accuracy.completedTasksWithActual > 0) {
          accuracyReports.push(accuracy);
          totalProjects++;
          totalTasksWithActual += accuracy.completedTasksWithActual;
          overallTotalEstimated += accuracy.totalEstimated;
          overallTotalActual += accuracy.totalActual;

          // æ‹…å½“è€…åˆ¥ãƒ‡ãƒ¼ã‚¿ã®çµ±åˆ
          for (const assigneeAcc of accuracy.assigneeAccuracy) {
            if (!allAssigneeData[assigneeAcc.assignee]) {
              allAssigneeData[assigneeAcc.assignee] = {
                totalTasks: 0,
                totalEstimated: 0,
                totalActual: 0
              };
            }

            allAssigneeData[assigneeAcc.assignee].totalTasks += assigneeAcc.totalTasks;
            allAssigneeData[assigneeAcc.assignee].totalEstimated += assigneeAcc.totalEstimated;
            allAssigneeData[assigneeAcc.assignee].totalActual += assigneeAcc.totalActual;
          }

          // ãƒ¯ãƒ¼ã‚¹ãƒˆã‚¿ã‚¹ã‚¯åé›†
          for (const worstTask of accuracy.worstTasks) {
            allWorstTasks.push({
              projectName: accuracy.projectName,
              ...worstTask
            });
          }
        }
      } catch (error) {
        Logger.log(`âœ— ç²¾åº¦è¨ˆç®—ã‚¨ãƒ©ãƒ¼ (${ganttSheet.getName()}): ${error.message}`);
      }
    }

    if (totalProjects === 0) {
      Logger.log('âš  è¦‹ç©ãƒ»å®Ÿç¸¾ã®ä¸¡æ–¹ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
      sendDiscordNotification('è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆ: åˆ†æå¯¾è±¡ã®ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', false);
      return;
    }

    // å…¨ä½“ç²¾åº¦
    const overallAccuracy = overallTotalEstimated > 0
      ? ((overallTotalActual - overallTotalEstimated) / overallTotalEstimated) * 100
      : 0;

    // æ‹…å½“è€…åˆ¥ç²¾åº¦ã®è¨ˆç®—
    const assigneeAccuracyList = [];
    for (const assignee in allAssigneeData) {
      const data = allAssigneeData[assignee];
      const errorRate = data.totalEstimated > 0
        ? ((data.totalActual - data.totalEstimated) / data.totalEstimated) * 100
        : 0;

      assigneeAccuracyList.push({
        assignee: assignee,
        totalTasks: data.totalTasks,
        totalEstimated: Math.round(data.totalEstimated * 10) / 10,
        totalActual: Math.round(data.totalActual * 10) / 10,
        errorRate: Math.round(errorRate * 10) / 10
      });
    }

    // èª¤å·®ç‡é †ã«ã‚½ãƒ¼ãƒˆï¼ˆçµ¶å¯¾å€¤ï¼‰
    assigneeAccuracyList.sort((a, b) => Math.abs(b.errorRate) - Math.abs(a.errorRate));

    // ãƒ¯ãƒ¼ã‚¹ãƒˆã‚¿ã‚¹ã‚¯ä¸Šä½10ä»¶
    const topWorstTasks = allWorstTasks
      .sort((a, b) => b.absoluteError - a.absoluteError)
      .slice(0, 10);

    // Discordé€šçŸ¥ä½œæˆ
    let summaryText = `**ğŸ“Š è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆ**\n\n`;
    summaryText += `**å…¨ä½“ã‚µãƒãƒªãƒ¼**\n`;
    summaryText += `â€¢ åˆ†æãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ•°: ${totalProjects}ä»¶\n`;
    summaryText += `â€¢ åˆ†æã‚¿ã‚¹ã‚¯æ•°: ${totalTasksWithActual}ä»¶\n`;
    summaryText += `â€¢ ç·è¦‹ç©å·¥æ•°: ${Math.round(overallTotalEstimated * 10) / 10}h\n`;
    summaryText += `â€¢ ç·å®Ÿç¸¾å·¥æ•°: ${Math.round(overallTotalActual * 10) / 10}h\n`;
    summaryText += `â€¢ å…¨ä½“ç²¾åº¦: ${Math.round(overallAccuracy * 10) / 10}% ${overallAccuracy > 0 ? '(è¶…é)' : overallAccuracy < 0 ? '(ä½™è£•)' : ''}\n\n`;

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ç²¾åº¦ï¼ˆèª¤å·®å¤§ãã„é †ï¼‰
    const sortedProjects = accuracyReports.sort((a, b) =>
      Math.abs(b.overallAccuracy) - Math.abs(a.overallAccuracy)
    );

    summaryText += `**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥ç²¾åº¦**\n`;
    for (const report of sortedProjects.slice(0, 10)) {
      summaryText += `\n**${report.projectName}**\n`;
      summaryText += `  è¦‹ç©: ${report.totalEstimated}h / å®Ÿç¸¾: ${report.totalActual}h\n`;
      summaryText += `  ç²¾åº¦: ${report.overallAccuracy}% (${report.completedTasksWithActual}ã‚¿ã‚¹ã‚¯)\n`;
    }

    if (sortedProjects.length > 10) {
      summaryText += `\n... ä»–${sortedProjects.length - 10}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ\n`;
    }

    // æ‹…å½“è€…åˆ¥ç²¾åº¦
    if (assigneeAccuracyList.length > 0) {
      summaryText += `\n**æ‹…å½“è€…åˆ¥ç²¾åº¦**\n`;

      for (const assigneeAcc of assigneeAccuracyList.slice(0, 10)) {
        summaryText += `\n**${assigneeAcc.assignee}**\n`;
        summaryText += `  è¦‹ç©: ${assigneeAcc.totalEstimated}h / å®Ÿç¸¾: ${assigneeAcc.totalActual}h\n`;
        summaryText += `  ç²¾åº¦: ${assigneeAcc.errorRate}% (${assigneeAcc.totalTasks}ã‚¿ã‚¹ã‚¯)\n`;
      }

      if (assigneeAccuracyList.length > 10) {
        summaryText += `\n... ä»–${assigneeAccuracyList.length - 10}äººã®æ‹…å½“è€…\n`;
      }
    }

    // è¦‹ç©èª¤å·®ãŒå¤§ãã„ã‚¿ã‚¹ã‚¯
    if (topWorstTasks.length > 0) {
      summaryText += `\n**âš ï¸ è¦‹ç©èª¤å·®ã®å¤§ãã„ã‚¿ã‚¹ã‚¯**\n`;

      for (const worstTask of topWorstTasks.slice(0, 5)) {
        const sign = worstTask.errorRate > 0 ? '+' : '';
        summaryText += `\nâ€¢ **${worstTask.task_name}** (${worstTask.projectName})\n`;
        summaryText += `  è¦‹ç©: ${worstTask.estimated}h / å®Ÿç¸¾: ${worstTask.actual}h / èª¤å·®: ${sign}${worstTask.errorRate}%\n`;
      }

      if (topWorstTasks.length > 5) {
        summaryText += `\n... ä»–${topWorstTasks.length - 5}ä»¶ã®ã‚¿ã‚¹ã‚¯\n`;
      }
    }

    // Discordé€šçŸ¥é€ä¿¡
    const payload = {
      embeds: [{
        title: 'ğŸ“Š è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆ',
        description: summaryText,
        color: Math.abs(overallAccuracy) > 20 ? 0xFF6B6B : (Math.abs(overallAccuracy) > 10 ? 0xFFA726 : 0x66BB6A),
        footer: { text: `åˆ†æå¯¾è±¡: ${totalTasksWithActual}ä»¶ã®ã‚¿ã‚¹ã‚¯` },
        timestamp: new Date().toISOString()
      }]
    };

    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(CONFIG.DISCORD_WEBHOOK_URL, options);
    Logger.log(`âœ“ è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆé€ä¿¡å®Œäº†: ${response.getResponseCode()}`);
    Logger.log(`âœ“ ${totalProjects}ä»¶ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€${totalTasksWithActual}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’åˆ†æ`);

  } catch (error) {
    Logger.log('âœ— è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message);
    sendDiscordNotification(
      `è¦‹ç©ç²¾åº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼å†…å®¹: ${error.message}`,
      true
    );
    throw error;
  }
}

// ============================================
// ãƒ†ã‚¹ãƒˆé–¢æ•°
// ============================================

/**
 * ä¾å­˜ã‚¿ã‚¹ã‚¯ãƒ–ãƒ­ãƒƒã‚«ãƒ¼æ¤œçŸ¥æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
 *
 * å®Ÿè¡Œæ–¹æ³•: GASã‚¨ãƒ‡ã‚£ã‚¿ã§ã“ã®é–¢æ•°ã‚’é¸æŠã—ã¦å®Ÿè¡Œ
 * çµæœç¢ºèª: ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ã¨Discordãƒãƒ£ãƒ³ãƒãƒ«ã§ç¢ºèª
 */
/**
 * æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
 * @param {Date} date - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾è±¡ã®æ—¥ä»˜
 * @return {string} YYYY-MM-DDå½¢å¼ã®æ–‡å­—åˆ—
 */
function formatDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// ============================================
// å¤‰æ›´æ¤œçŸ¥æ©Ÿèƒ½ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
// ============================================

/**
 * Ganttã‚·ãƒ¼ãƒˆã®æœ€çµ‚åŒæœŸæ—¥æ™‚ã‚’å–å¾—
 * @param {Sheet} sheet - Ganttã‚·ãƒ¼ãƒˆ
 * @returns {Date|null} - æœ€çµ‚åŒæœŸæ—¥æ™‚ï¼ˆæœªåŒæœŸã®å ´åˆã¯nullï¼‰
 */
function getLastSyncTime(sheet) {
  try {
    const props = PropertiesService.getDocumentProperties();
    const key = `lastSync_${sheet.getName()}`;
    const value = props.getProperty(key);
    return value ? new Date(value) : null;
  } catch (error) {
    return null;
  }
}

/**
 * Ganttã‚·ãƒ¼ãƒˆã®æœ€çµ‚åŒæœŸæ—¥æ™‚ã‚’è¨˜éŒ²
 * @param {Sheet} sheet - Ganttã‚·ãƒ¼ãƒˆ
 */
function setLastSyncTime(sheet) {
  try {
    const props = PropertiesService.getDocumentProperties();
    const key = `lastSync_${sheet.getName()}`;
    const now = new Date().toISOString();
    props.setProperty(key, now);
  } catch (error) {
    Logger.log(`âš  æœ€çµ‚åŒæœŸæ—¥æ™‚ã®è¨˜éŒ²å¤±æ•—: ${sheet.getName()} - ${error.message}`);
  }
}

/**
 * Ganttã‚·ãƒ¼ãƒˆãŒåŒæœŸãŒå¿…è¦ã‹ã©ã†ã‹åˆ¤å®š
 * @param {Sheet} sheet - Ganttã‚·ãƒ¼ãƒˆ
 * @param {number} minIntervalMinutes - æœ€å°åŒæœŸé–“éš”ï¼ˆåˆ†ï¼‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
 * @returns {boolean} - åŒæœŸãŒå¿…è¦ãªã‚‰true
 */
function shouldSyncSheet(sheet, minIntervalMinutes = 5) {
  const lastSyncTime = getLastSyncTime(sheet);

  // åˆå›åŒæœŸï¼ˆæœ€çµ‚åŒæœŸæ—¥æ™‚ãŒæœªè¨­å®šï¼‰
  if (!lastSyncTime) {
    return true;
  }

  // ç¾åœ¨æ™‚åˆ»ã¨ã®å·®åˆ†ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
  const now = new Date();
  const diffMinutes = (now - lastSyncTime) / (1000 * 60);

  // æœ€å°é–“éš”ã‚’çµŒéã—ã¦ã„ã‚Œã°åŒæœŸãŒå¿…è¦
  return diffMinutes >= minIntervalMinutes;
}
